<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Comparing Azure Container Registry Project Teleport with standard docker pull, using Azure Kubernetes Service | Azure Container Registry</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/acr/assets/css/0.styles.1adce09e.css" as="style"><link rel="preload" href="/acr/assets/js/app.3ca3959d.js" as="script"><link rel="preload" href="/acr/assets/js/2.4abe739f.js" as="script"><link rel="preload" href="/acr/assets/js/58.249e8925.js" as="script"><link rel="prefetch" href="/acr/assets/js/10.080d8072.js"><link rel="prefetch" href="/acr/assets/js/11.a8cae62e.js"><link rel="prefetch" href="/acr/assets/js/12.e62ede07.js"><link rel="prefetch" href="/acr/assets/js/13.88956df0.js"><link rel="prefetch" href="/acr/assets/js/14.da996b77.js"><link rel="prefetch" href="/acr/assets/js/15.128615bf.js"><link rel="prefetch" href="/acr/assets/js/16.28bd344b.js"><link rel="prefetch" href="/acr/assets/js/17.3154ce14.js"><link rel="prefetch" href="/acr/assets/js/18.1a01df13.js"><link rel="prefetch" href="/acr/assets/js/19.d6cd2dad.js"><link rel="prefetch" href="/acr/assets/js/20.3cb003a6.js"><link rel="prefetch" href="/acr/assets/js/21.b60fd558.js"><link rel="prefetch" href="/acr/assets/js/22.7d86dba4.js"><link rel="prefetch" href="/acr/assets/js/23.dd656471.js"><link rel="prefetch" href="/acr/assets/js/24.e228cfdd.js"><link rel="prefetch" href="/acr/assets/js/25.197c3531.js"><link rel="prefetch" href="/acr/assets/js/26.29caa7ed.js"><link rel="prefetch" href="/acr/assets/js/27.fb8da073.js"><link rel="prefetch" href="/acr/assets/js/28.6e4543d4.js"><link rel="prefetch" href="/acr/assets/js/29.a76509db.js"><link rel="prefetch" href="/acr/assets/js/3.f910cf4c.js"><link rel="prefetch" href="/acr/assets/js/30.994ccbbb.js"><link rel="prefetch" href="/acr/assets/js/31.f2c11b52.js"><link rel="prefetch" href="/acr/assets/js/32.840e79d8.js"><link rel="prefetch" href="/acr/assets/js/33.2df67567.js"><link rel="prefetch" href="/acr/assets/js/34.e38730f2.js"><link rel="prefetch" href="/acr/assets/js/35.46229160.js"><link rel="prefetch" href="/acr/assets/js/36.9f898214.js"><link rel="prefetch" href="/acr/assets/js/37.9c3a93a2.js"><link rel="prefetch" href="/acr/assets/js/38.2cbce8d9.js"><link rel="prefetch" href="/acr/assets/js/39.f4bfa261.js"><link rel="prefetch" href="/acr/assets/js/4.1d1d93b6.js"><link rel="prefetch" href="/acr/assets/js/40.bc1f46d1.js"><link rel="prefetch" href="/acr/assets/js/41.2dbb6a30.js"><link rel="prefetch" href="/acr/assets/js/42.84fa6a12.js"><link rel="prefetch" href="/acr/assets/js/43.428cb1ec.js"><link rel="prefetch" href="/acr/assets/js/44.3b6b967d.js"><link rel="prefetch" href="/acr/assets/js/45.fd0d1d9e.js"><link rel="prefetch" href="/acr/assets/js/46.19cb06fd.js"><link rel="prefetch" href="/acr/assets/js/47.8c0d7628.js"><link rel="prefetch" href="/acr/assets/js/48.619e29e6.js"><link rel="prefetch" href="/acr/assets/js/49.3ba8bd2c.js"><link rel="prefetch" href="/acr/assets/js/5.943fad70.js"><link rel="prefetch" href="/acr/assets/js/50.0c02f626.js"><link rel="prefetch" href="/acr/assets/js/51.b822281a.js"><link rel="prefetch" href="/acr/assets/js/52.9a8a029d.js"><link rel="prefetch" href="/acr/assets/js/53.57ca9884.js"><link rel="prefetch" href="/acr/assets/js/54.86e09cf3.js"><link rel="prefetch" href="/acr/assets/js/55.21039511.js"><link rel="prefetch" href="/acr/assets/js/56.b6f67eae.js"><link rel="prefetch" href="/acr/assets/js/57.0266cf09.js"><link rel="prefetch" href="/acr/assets/js/59.a2f8607d.js"><link rel="prefetch" href="/acr/assets/js/6.c89b0c48.js"><link rel="prefetch" href="/acr/assets/js/60.f13d2f1c.js"><link rel="prefetch" href="/acr/assets/js/7.cf63200c.js"><link rel="prefetch" href="/acr/assets/js/8.9e525704.js"><link rel="prefetch" href="/acr/assets/js/9.b9ebe781.js">
    <link rel="stylesheet" href="/acr/assets/css/0.styles.1adce09e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/acr/" class="home-link router-link-active"><img src="/acr/files/acr.svg" alt="Azure Container Registry" class="logo"> <span class="site-name can-hide">Azure Container Registry</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/acr/" aria-current="page" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/acr/#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/acr/#blog-posts" class="sidebar-link">Blog posts</a></li><li class="sidebar-sub-header"><a href="/acr/#links" class="sidebar-link">Links</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Teleport</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tasks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Integration</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="comparing-azure-container-registry-project-teleport-with-standard-docker-pull-using-azure-kubernetes-service"><a href="#comparing-azure-container-registry-project-teleport-with-standard-docker-pull-using-azure-kubernetes-service" class="header-anchor">#</a> Comparing Azure Container Registry Project Teleport with standard docker pull, using Azure Kubernetes Service</h1> <p>To compare the performance benefits of Project Teleport two deployments will be made allowing the same image to be deployed to an AKS node with Project Teleport, and another without Project Teleport, allowing node recycling to reset the nodes, clearing any cached images.</p> <p>Project Teleport is node specific. If an image is pulled to a node, with teleport enabled, the expanded layers are mounted.
If a second copy of the same image is pulled to the same node, even if pulled from Project Teleport expanded repository, the node will identify common layers and mount the local layers from the previously pulled image.</p> <p>To avoid layer sharing, testing the same image with and without Project Teleport enabled, two additional nodepools will be created. The additional nodepools will enable clearing any cached images and layers by scaling the nodepool to zero, then back to one.</p> <p>When complete, the AKS cluster will have (3) nodepools:</p> <ul><li><code>nodepool1</code> - The system nodepool. No workloads will be scheduled here.</li> <li><code>teleporter</code> - A Project Teleport enabled nodepool, with a single node</li> <li><code>shuttle</code> - The standard method of transport of container images, with a single node.</li></ul> <p>This tutorial assumes you've already completed the steps to create a Teleport enabled AKS Cluster, and Teleport enabled ACR Instance. If you haven't already done so, complete the steps in: <a href="/acr/teleport/aks-getting-started.html">Integrate Azure Container Registry and Project Teleport with Azure Kubernetes Service</a></p> <h2 id="set-environment-variables"><a href="#set-environment-variables" class="header-anchor">#</a> Set environment variables</h2> <p>Configure variables unique to your environment. Note the ACR and AKS instances must both be in one of the <a href="/acr/teleport/#preview-constraints">teleport supported regions</a>.</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>AKS=myaks
AKS_RG=${AKS}-rg
LOCATION=westus2
K8S_VERSION=1.19.7
ACR=myacr
ACR_URL=${ACR}.azurecr.io
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="clone-the-teleport-samples-repo"><a href="#clone-the-teleport-samples-repo" class="header-anchor">#</a> Clone the Teleport samples repo</h2> <p>Sample kubernetes deployment files and a <code>check-expansion.sh</code> script are provided at: https://github.com/Azure/acr/tree/main/docs/teleport. Only a few files are necessary. You may either <code>git clone</code> the repo, or copy the individual files referenced below.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/Azure/acr.git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="import-images-for-teleportation"><a href="#import-images-for-teleportation" class="header-anchor">#</a> Import images for teleportation</h2> <p>For completeness of this walkthrough, the azure-vote application is used, which includes a 944mb <code>azure-vote-front:v1</code> image. To expand the layers, import the images into a teleport enabled registry, in the same region as the AKS cluster.</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>az acr import \
  --source mcr.microsoft.com/azuredocs/azure-vote-front:v1 \
  --name $ACR \
  --image azure-vote-front:v1

az acr import \
  --source mcr.microsoft.com/oss/bitnami/redis:6.0.8 \
  --name $ACR \
  --image redis:6.0.8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="confirm-import-and-teleport-expansion"><a href="#confirm-import-and-teleport-expansion" class="header-anchor">#</a> Confirm import and teleport expansion</h2> <p>Confirm the <code>azure-vote-front</code> repository is set for teleport expansion:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr repository show \
  --repository azure-vote-front \
  -o jsonc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Look for <code>&quot;teleportEnabled&quot;: true,</code> in the output</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;changeableAttributes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;deleteEnabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;listEnabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;readEnabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teleportEnabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;writeEnabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Although the repository is configured for teleport expansion, each image upload will take time to be expanded on push. The length of time is based on the quantity and size of layers, however the expansion should be completed within seconds.</p> <blockquote><p><strong>Note:</strong> ACR webhooks indicate when an artifact is pushed and available. The push event occurs prior to layer expansion. In a future release, a new webhook and EventGrid notification will be added indicating the image has been expanded, and ready for teleportation.</p></blockquote> <p>At this point in the Teleport preview, check expansion using the <a href="./check-expansion.sh">check-expansion.sh</a> script. As the script uses a <code>/mount</code> api, basic auth is required. An <a href="https://aka.ms/acr/tokens" target="_blank" rel="noopener noreferrer">ACR Token<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is created and saved as environment variables.</p> <blockquote><p>Note: If <code>check-expansion.sh</code> fails to execute (<code>-bash: ./check-expansion.sh: Permission denied</code>), assure the file is set to executable: <code>sudo chmod +x ./check-expansion.sh</code></p></blockquote> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>export ACR_USER=teleport-token
export ACR_PWD=$(az acr token create \
  --name teleport-token \
  --registry $ACR \
  --scope-map _repositories_pull \
  --query credentials.passwords[0].value -o tsv)

./check-expansion.sh teleport azure-vote-front v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="add-nodes-for-teleporters-and-shuttles"><a href="#add-nodes-for-teleporters-and-shuttles" class="header-anchor">#</a> Add nodes for teleporters and shuttles</h2> <p>Two nodepools will be added to enable teleportation, and a comparison for standard transport. An <code>acr-teleport</code> label is added for scheduling onto specific nodes. The system nodepool (<code>nodepool1</code>) is avoided to enable <a href="#cleanup">clearing the image cache</a> by scaling the nodepool to zero then back to one.</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>az aks nodepool add \
  --resource-group $AKS_RG \
  --cluster-name $AKS \
  --name teleporter \
  --node-count 1 \
  --aks-custom-headers EnableACRTeleport=true \
  --labels acr-teleport=enabled

az aks nodepool add \
  --resource-group $AKS_RG \
  --cluster-name $AKS \
  --name shuttle \
  --node-count 1 \
  --labels acr-teleport=disabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="deploy-to-aks"><a href="#deploy-to-aks" class="header-anchor">#</a> Deploy to AKS</h2> <p>Update the <a href="./samples/azure-vote-teleport.yaml">azure-vote-teleport.yaml</a> and <a href="./samples/azure-vote-shuttle.yaml">azure-vote-shuttle.yaml</a> files to reference your registry name:</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> azure<span class="token punctuation">-</span>vote<span class="token punctuation">-</span>back
    <span class="token key atrule">image</span><span class="token punctuation">:</span> &lt;registryName<span class="token punctuation">&gt;</span>.azurecr.io/redis<span class="token punctuation">:</span>6.0.8
  <span class="token punctuation">...</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> azure<span class="token punctuation">-</span>vote<span class="token punctuation">-</span>front
    <span class="token key atrule">image</span><span class="token punctuation">:</span> &lt;registryName<span class="token punctuation">&gt;</span>.azurecr.io/azure<span class="token punctuation">-</span>vote<span class="token punctuation">-</span>front<span class="token punctuation">:</span>v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="deploy-with-standard-pull-performance"><a href="#deploy-with-standard-pull-performance" class="header-anchor">#</a> Deploy with standard pull performance</h3> <p>Deploy the <em>shuttle</em> podspec:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>kubectl apply -f azure-vote-shuttle.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Get the list of pods to find the azure-vote-front pod. The shorthand version can be used if only one pod is named <code>azure-vote-front</code>. You may need to run the command a few times until the image has been pulled and expanded on the node.</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>kubectl get pods
kubectl describe pod azure-vote-front-shuttle
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Under the <code>events</code> list, an entry for <code>Successfully pulled image...</code> provides the pull time. Note the length before proceeding to the teleport version.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  36s   default-scheduler  Successfully assigned default/azure-vote-front-5c976dbbd9-tckdz to aks-shuttle-10583637-vmss000000
  Normal  Pulling    35s   kubelet            Pulling image <span class="token string">&quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:v1&quot;</span>
  Normal  Pulled     1s    kubelet            Successfully pulled image <span class="token string">&quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:v1&quot;</span> <span class="token keyword">in</span> <span class="token number">34</span>.738162s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>If <code>already present on machine</code> is returned, this indicates the image was previously pulled and cached. See <a href="#cleanup">recycle nodepool</a> to clear the cache.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  2m12s  default-scheduler  Successfully assigned default/azure-vote-front-5bdfc85f9c-d7z8b to aks-shuttle-10583637-vmss000000
  Normal  Pulled     2m11s  kubelet            Container image <span class="token string">&quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:v1&quot;</span> already present on machine
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="deploy-with-teleport-performance"><a href="#deploy-with-teleport-performance" class="header-anchor">#</a> Deploy with Teleport performance</h3> <p>Deploy the <em>teleport</em> podspec:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>kubectl apply -f azure-vote-teleport.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Get the list of pods to find the azure-vote-front pod. The shorthand version can be used if only one pod is named <code>azure-vote-front</code>. You may need to run the command a few times until the image has been pulled and expanded on the node.</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>kubectl describe pod azure-vote-front-teleport
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Under the <code>events</code> list, an entry for <code>Successfully pulled image...</code> provides the pull time. Note the length should be dramatically faster.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  12s   default-scheduler  Successfully assigned default/azure-vote-front-teleport-5bf865d976-lm4bj to aks-teleporter-10583637-vmss000000
  Normal  Pulling    11s   kubelet            Pulling image <span class="token string">&quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:v1&quot;</span>
  Normal  Pulled     3s    kubelet            Successfully pulled image <span class="token string">&quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:v1&quot;</span> <span class="token keyword">in</span> <span class="token number">8</span>.011045191s
  Normal  Created    3s    kubelet            Created container azure-vote-front-teleport
  Normal  Started    3s    kubelet            Started container azure-vote-front-teleport
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="browse-the-apps"><a href="#browse-the-apps" class="header-anchor">#</a> Browse the apps</h3> <p>To view the voting apps:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>kubectl get services
NAME                        TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)        AGE
azure-vote-back-shuttle     ClusterIP      10.0.159.177   &lt;none&gt;          6379/TCP       15m
azure-vote-back-teleport    ClusterIP      10.0.229.255   &lt;none&gt;          6379/TCP       21m
azure-vote-front-shuttle    LoadBalancer   10.0.155.50    x.x.x.x         80:30276/TCP   15m
azure-vote-front-teleport   LoadBalancer   10.0.60.1      x.x.x.x         80:30259/TCP   21m
kubernetes                  ClusterIP      10.0.0.1       &lt;none&gt;          443/TCP        118m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Copy the EXTERNAL-IP, and paste in the browser to view each voting app.</p> <h3 id="cleanup"><a href="#cleanup" class="header-anchor">#</a> Cleanup</h3> <p>To reset the nodes, delete the two deployments:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>kubectl delete -f azure-vote-teleport.yaml
kubectl delete -f azure-vote-shuttle.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Clear the image cache, and any teleport mounts:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>az aks scale \
  --resource-group $AKS_RG \
  --name $AKS \
  --nodepool-name teleporter \
  --node-count 0

az aks scale \
  --resource-group $AKS_RG \
  --name $AKS \
  --nodepool-name teleporter \
  --node-count 1

az aks scale \
  --resource-group $AKS_RG \
  --name $AKS \
  --nodepool-name shuttle \
  --node-count 0

az aks scale \
  --resource-group $AKS_RG \
  --name $AKS \
  --nodepool-name shuttle \
  --node-count 1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="performance-profile-of-teleport"><a href="#performance-profile-of-teleport" class="header-anchor">#</a> Performance profile of teleport</h2> <p>The Voting app has a significant performance delta, comparing a normal pull time of 34.7 seconds, with 8.0 seconds of teleport. While impressive, you may have assumed a larger difference.</p> <p>Teleport prototype-1 is based on mounting expanded layers. For each layer of an image, the decompression of a layer is traded off for a mount. Therefore, the larger the layer count, the slightly longer the start time.</p> <p>The <code>azure-vote-front</code> image has <em><strong>29 layers</strong></em>, which requires 29 mounts. When pulling the image without teleport, the 944mb of content must be decompressed, but multiple decompression threads can run concurrently.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">docker</span> inspect <span class="token operator">&lt;</span>registryName<span class="token operator">&gt;</span>.azurecr.io/azure-vote-front:v1
<span class="token punctuation">..</span>.
<span class="token string">&quot;RootFS&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;layers&quot;</span>,
  <span class="token string">&quot;Layers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;sha256:e27a10675c5656bafb7bfa9e4631e871499af0a5ddfda3cebc0ac401dfe19382&quot;</span>,
      <span class="token string">&quot;sha256:851f3e348c69d8959d326f0bab975c03f9813eec33aba389aa7c569953510433&quot;</span>,
      <span class="token string">&quot;sha256:06f4de5fefeae30802d336e8c234b9c0989542fb80efd4f83be06c41aba26d9f&quot;</span>,
      <span class="token string">&quot;sha256:b31411566900643c38169980a21093c23e0a12a12ffea78b1921d07dd40372bd&quot;</span>,
      <span class="token string">&quot;sha256:6662dddae6aa455371366ed12400556a29e049373ea27c089a24634e3098cb48&quot;</span>,
      <span class="token string">&quot;sha256:4ea12feed6a9386d7bdac8b26073b1209f0f39781a5d157026dfb5a918c95db7&quot;</span>,
      <span class="token string">&quot;sha256:e7cee6196d865755606c73b82004784273cd423217cba8faf650b6707d3b5059&quot;</span>,
      <span class="token string">&quot;sha256:b15d32f8b6aa975b8be84e825952094d2f20296777a2bb5fad3fb270ca05a776&quot;</span>,
      <span class="token string">&quot;sha256:5e8efc7c6f4fee7fecfc685b742293a5300cc3180262a144a2fed54c46597129&quot;</span>,
      <span class="token string">&quot;sha256:4f6e0a34a0535f5cd6b76d06aae861c3ced179b3b115d2850af0e2f0bcefeffc&quot;</span>,
      <span class="token string">&quot;sha256:5ac43729c58be5ecb0fc13b164fb4f06f0afc13394735e8ac10cdb0f75311195&quot;</span>,
      <span class="token string">&quot;sha256:491bd929c5bfcb0639a6c43d07be0aac225dc0da28379e99f617480599825e5f&quot;</span>,
      <span class="token string">&quot;sha256:b18e79d2742360b7b0d81493e8a8beced51953c8a8f73fe4b228e47e8aeb292b&quot;</span>,
      <span class="token string">&quot;sha256:55ebcfb2ad17cafdada768b6ca43e3f4e51bc589757b22337b94a499354aa052&quot;</span>,
      <span class="token string">&quot;sha256:1a350e9420b7eac6b50172334afd6354d89749c62822951596bac9085cb9fb1e&quot;</span>,
      <span class="token string">&quot;sha256:7b3929993879466a3abee028d3fb490d83c211ab5723e29765ed17c98db5b4e3&quot;</span>,
      <span class="token string">&quot;sha256:ddeb470c209923815a410d35dd45a6710bc285955b5ef30d92a003d38bd68f3b&quot;</span>,
      <span class="token string">&quot;sha256:c30da5f5d23cec0997d05337dd1113872ba56b38a59bf96922572f07d65b94a0&quot;</span>,
      <span class="token string">&quot;sha256:a7364327f2826e4991e3675271350c9e7b858e33abbe77aacfbbff00a4b59455&quot;</span>,
      <span class="token string">&quot;sha256:f8af872e501840a2de13260830960f612560d9ee755ae07a37c30758e8568444&quot;</span>,
      <span class="token string">&quot;sha256:57fe04427c69233864b729d60d3c9c7fe8a43e950cb442a650101a357998c8c2&quot;</span>,
      <span class="token string">&quot;sha256:cde1a4e95d8bea636972733fde8f223d1dda2c2425ec7de8ca5b078391723c11&quot;</span>,
      <span class="token string">&quot;sha256:efa870440d9c6defc6447ad9d3d214312ba3dc0c665c723b793d14d241d811e1&quot;</span>,
      <span class="token string">&quot;sha256:a9f64da753644ba8e18846cb23010c8e730de34701b5f519591167722a89784b&quot;</span>,
      <span class="token string">&quot;sha256:2131d41261d2d13cae8b024c5a20e65fe8ee8f98d04bfd238124210b94115d69&quot;</span>,
      <span class="token string">&quot;sha256:9d93163e41ffdad4659db82f267091b4a478f1235be1b25438407e79e80ed28b&quot;</span>,
      <span class="token string">&quot;sha256:d9aeb057eef2070b1260cceeefb0933755f62504cf34efe2bf4f113043bf7493&quot;</span>,
      <span class="token string">&quot;sha256:5e85a99d34e4a9aea5bdc845fb30587b172393ebf7d71ddbb1b325e3fa728090&quot;</span>,
      <span class="token string">&quot;sha256:ab48c9fa73df063cfafaa0338c06ec44ba3d29a3ce6adde3fedf42d2d0c0ee91&quot;</span>
  <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="comparing-fewer-layers"><a href="#comparing-fewer-layers" class="header-anchor">#</a> Comparing fewer layers</h3> <p>To gauge the difference between layers and size, clone the <a href="https://github.com/Azure-Samples/azure-voting-app-redis" target="_blank" rel="noopener noreferrer">Azure-Samples/azure-voting-app-redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> repo and build the image with the <code>--squash</code> flag.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">docker</span> build --force-rm --squash -t <span class="token variable">${ACR}</span>.azurecr.io/azure-vote-front:squashed <span class="token builtin class-name">.</span>
<span class="token function">docker</span> push <span class="token variable">${ACR}</span>.azurecr.io/azure-vote-front:squashed
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>Change the <code>:tag</code> references in <code>azure-vote-shuttle.yaml</code> and <code>azure-vote-teleport.yaml</code> files to reference the <code>:squashed</code> tag.<div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>    <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> azure<span class="token punctuation">-</span>vote<span class="token punctuation">-</span>front<span class="token punctuation">-</span>teleport
      <span class="token key atrule">image</span><span class="token punctuation">:</span> &lt;registryName<span class="token punctuation">&gt;</span>.azurecr.io/azure<span class="token punctuation">-</span>vote<span class="token punctuation">-</span>front<span class="token punctuation">:</span>squashed
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li>Follow the steps above to <a href="#cleanup">recycle</a> the nodes, and <a href="#deploy-with-standard-pull-performance">redeploy the two apps</a>.</li></ul> <p>The resulting times should reflect <strong>~31.7 seconds</strong> for the standard docker pull/decompress and <strong>~1.9 seconds</strong> for teleportation of a single layer.</p> <table><thead><tr><th>Size</th> <th>Layers</th> <th>Docker</th> <th>Teleport</th></tr></thead> <tbody><tr><td>944mb</td> <td>28</td> <td>34.7</td> <td>8</td></tr> <tr><td>929mb</td> <td>1</td> <td>31.7</td> <td>1.9</td></tr></tbody></table> <p>That's a <em>further</em> reduction from 8.0 seconds for 28 layers to 1.9 seconds for a single layer. This highlights the performance profile of mounting expanded layers, compared to pulling and decompressing layers.</p> <h4 id="shuttle-deployed-single-layer-image"><a href="#shuttle-deployed-single-layer-image" class="header-anchor">#</a> Shuttle deployed single layer image</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  9m55s  default-scheduler  Successfully assigned default/azure-vote-front-6ff785596-4d62g to aks-shuttle-10583637-vmss000000
  Normal  Pulling    9m54s  kubelet            Pulling image &quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:squashed&quot;
  Normal  Pulled     9m22s  kubelet            Successfully pulled image &quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:squashed&quot; in 31.711601788s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="teleported-single-layer-image"><a href="#teleported-single-layer-image" class="header-anchor">#</a> Teleported single layer image</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  37s   default-scheduler  Successfully assigned default/azure-vote-front-teleport-5fbc9b754f-lrtpw to aks-teleporter-10583637-vmss000000
  Normal  Pulling    36s   kubelet            Pulling image &quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:squashed&quot;
  Normal  Pulled     34s   kubelet            Successfully pulled image &quot;&lt;registryName&gt;.azurecr.io/azure-vote-front:squashed&quot; in 1.891985507s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="balancing-layers-and-size"><a href="#balancing-layers-and-size" class="header-anchor">#</a> Balancing layers and size</h3> <p>While you might consider flattening your images to one layer for fast mounting, you may have contention on a single mount point. The purpose of the Project Teleport preview is to get further metrics on the usage to understand the art and science of image layers. The Project Teleport design does not require an image owner to make changes to use Teleport. Teleport works with your existing container images. However, with each technology, there are always optimizations that may be made based on the deployment target.</p> <p>One thing is always common about image performance. The smaller you can make your overall container image, the faster it will run.</p> <h2 id="providing-feedback"><a href="#providing-feedback" class="header-anchor">#</a> Providing feedback</h2> <p>Please contact the Project Teleport technicians, and other fellow Teleport Red-Shirts in the <a href="https://aka.ms/acr/teleport/red-shirts" target="_blank" rel="noopener noreferrer">Teleport Red-Shirts teams channel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azure/acr/edit/master/docs/teleport/aks-teleport-comparison.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/acr/assets/js/app.3ca3959d.js" defer></script><script src="/acr/assets/js/2.4abe739f.js" defer></script><script src="/acr/assets/js/58.249e8925.js" defer></script>
  </body>
</html>
