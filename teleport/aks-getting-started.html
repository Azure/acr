<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Integrate Azure Container Registry and Project Teleport with Azure Kubernetes Service (preview) | Azure Container Registry</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/acr/assets/css/0.styles.1adce09e.css" as="style"><link rel="preload" href="/acr/assets/js/app.3ca3959d.js" as="script"><link rel="preload" href="/acr/assets/js/2.4abe739f.js" as="script"><link rel="preload" href="/acr/assets/js/57.0266cf09.js" as="script"><link rel="prefetch" href="/acr/assets/js/10.080d8072.js"><link rel="prefetch" href="/acr/assets/js/11.a8cae62e.js"><link rel="prefetch" href="/acr/assets/js/12.e62ede07.js"><link rel="prefetch" href="/acr/assets/js/13.88956df0.js"><link rel="prefetch" href="/acr/assets/js/14.da996b77.js"><link rel="prefetch" href="/acr/assets/js/15.128615bf.js"><link rel="prefetch" href="/acr/assets/js/16.28bd344b.js"><link rel="prefetch" href="/acr/assets/js/17.3154ce14.js"><link rel="prefetch" href="/acr/assets/js/18.1a01df13.js"><link rel="prefetch" href="/acr/assets/js/19.d6cd2dad.js"><link rel="prefetch" href="/acr/assets/js/20.3cb003a6.js"><link rel="prefetch" href="/acr/assets/js/21.b60fd558.js"><link rel="prefetch" href="/acr/assets/js/22.7d86dba4.js"><link rel="prefetch" href="/acr/assets/js/23.dd656471.js"><link rel="prefetch" href="/acr/assets/js/24.e228cfdd.js"><link rel="prefetch" href="/acr/assets/js/25.197c3531.js"><link rel="prefetch" href="/acr/assets/js/26.29caa7ed.js"><link rel="prefetch" href="/acr/assets/js/27.fb8da073.js"><link rel="prefetch" href="/acr/assets/js/28.6e4543d4.js"><link rel="prefetch" href="/acr/assets/js/29.a76509db.js"><link rel="prefetch" href="/acr/assets/js/3.f910cf4c.js"><link rel="prefetch" href="/acr/assets/js/30.994ccbbb.js"><link rel="prefetch" href="/acr/assets/js/31.f2c11b52.js"><link rel="prefetch" href="/acr/assets/js/32.840e79d8.js"><link rel="prefetch" href="/acr/assets/js/33.2df67567.js"><link rel="prefetch" href="/acr/assets/js/34.e38730f2.js"><link rel="prefetch" href="/acr/assets/js/35.46229160.js"><link rel="prefetch" href="/acr/assets/js/36.9f898214.js"><link rel="prefetch" href="/acr/assets/js/37.9c3a93a2.js"><link rel="prefetch" href="/acr/assets/js/38.2cbce8d9.js"><link rel="prefetch" href="/acr/assets/js/39.f4bfa261.js"><link rel="prefetch" href="/acr/assets/js/4.1d1d93b6.js"><link rel="prefetch" href="/acr/assets/js/40.bc1f46d1.js"><link rel="prefetch" href="/acr/assets/js/41.2dbb6a30.js"><link rel="prefetch" href="/acr/assets/js/42.84fa6a12.js"><link rel="prefetch" href="/acr/assets/js/43.428cb1ec.js"><link rel="prefetch" href="/acr/assets/js/44.3b6b967d.js"><link rel="prefetch" href="/acr/assets/js/45.fd0d1d9e.js"><link rel="prefetch" href="/acr/assets/js/46.19cb06fd.js"><link rel="prefetch" href="/acr/assets/js/47.8c0d7628.js"><link rel="prefetch" href="/acr/assets/js/48.619e29e6.js"><link rel="prefetch" href="/acr/assets/js/49.3ba8bd2c.js"><link rel="prefetch" href="/acr/assets/js/5.943fad70.js"><link rel="prefetch" href="/acr/assets/js/50.0c02f626.js"><link rel="prefetch" href="/acr/assets/js/51.b822281a.js"><link rel="prefetch" href="/acr/assets/js/52.9a8a029d.js"><link rel="prefetch" href="/acr/assets/js/53.57ca9884.js"><link rel="prefetch" href="/acr/assets/js/54.86e09cf3.js"><link rel="prefetch" href="/acr/assets/js/55.21039511.js"><link rel="prefetch" href="/acr/assets/js/56.b6f67eae.js"><link rel="prefetch" href="/acr/assets/js/58.249e8925.js"><link rel="prefetch" href="/acr/assets/js/59.a2f8607d.js"><link rel="prefetch" href="/acr/assets/js/6.c89b0c48.js"><link rel="prefetch" href="/acr/assets/js/60.f13d2f1c.js"><link rel="prefetch" href="/acr/assets/js/7.cf63200c.js"><link rel="prefetch" href="/acr/assets/js/8.9e525704.js"><link rel="prefetch" href="/acr/assets/js/9.b9ebe781.js">
    <link rel="stylesheet" href="/acr/assets/css/0.styles.1adce09e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/acr/" class="home-link router-link-active"><img src="/acr/files/acr.svg" alt="Azure Container Registry" class="logo"> <span class="site-name can-hide">Azure Container Registry</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/acr/" aria-current="page" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/acr/#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/acr/#blog-posts" class="sidebar-link">Blog posts</a></li><li class="sidebar-sub-header"><a href="/acr/#links" class="sidebar-link">Links</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Teleport</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tasks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Integration</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="integrate-azure-container-registry-and-project-teleport-with-azure-kubernetes-service-preview"><a href="#integrate-azure-container-registry-and-project-teleport-with-azure-kubernetes-service-preview" class="header-anchor">#</a> Integrate Azure Container Registry and Project Teleport with Azure Kubernetes Service (preview)</h1> <p><a href="https://github.com/azurecr/teleport" target="_blank" rel="noopener noreferrer">Project Teleport<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> allows container hosts to access pre-expanded layers within an <a href="https://aka.ms/acr" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that is in the same region as the container host. Using pre-expanded layers removes the time for compute and memory to decompress layers that are already available within the Azure network. Removing this decompression also reduces the time to create the instance of the running container.</p> <p>Using Project Teleport with ACR and AKS is in private preview. See <a href="#enable-project-teleport-on-an-acr">Enable Project Teleport on an ACR</a> for access.</p> <blockquote><p>AKS preview features are available on a self-service, opt-in basis. Previews are provided &quot;as is&quot; and &quot;as available,&quot; and they're excluded from the service-level agreements and limited warranty. AKS previews are partially covered by customer support on a best-effort basis. As such, these features aren't meant for production use. AKS preview features aren't available in Azure Government or Azure China 21Vianet clouds. For more information, see the following support articles:</p> <ul><li><a href="https://docs.microsoft.com/azure/aks/support-policies" target="_blank" rel="noopener noreferrer">AKS support policies<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.microsoft.com/en-us/azure/aks/faq" target="_blank" rel="noopener noreferrer">Azure support FAQ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>ACR Preview features are available on a self-service, opt-in basis. Previews are provided &quot;as is&quot; and &quot;as available,&quot; and they're excluded from the service-level agreements and limited warranty. ACR previews are partially covered by customer support on a best-effort basis. As such, these features aren't meant for production use. ACR preview features aren't available in Azure Government or Azure China 21Vianet clouds.</p> <ul><li>Project Teleport Support is provided through a <a href="https://aka.ms/acr/teleport/red-shirts" target="_blank" rel="noopener noreferrer">Microsoft Teams channel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. <a href="https://aka.ms/acr/teleport/signup" target="_blank" rel="noopener noreferrer">Requesting access to Project Teleport<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <h2 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h2> <ul><li>Ensure you have the Azure CLI, version 2.13.0 or greater installed.</li> <li>Ensure you have the <code>aks-preview</code> CLI extension 0.4.73 or greater installed.</li> <li>Ensure you have Project Teleport enabled on your ACR.</li> <li>Ensure you have the AKS <code>EnableACRTeleport</code> feature flag under <code>Microsoft.ContainerService</code> enabled.</li></ul> <h2 id="preview-limitations"><a href="#preview-limitations" class="header-anchor">#</a> Preview Limitations</h2> <ul><li>AKS node pools must use Kubernetes 1.19.7 or greater.</li> <li>AKS node pools must use <code>containerd</code> as the container runtime. AKS clusters with node pools using Kubernetes before 1.19.0 use Moby as the container runtime.</li> <li>Each ACR used must have Project Teleport enabled.</li> <li>Each ACR must use the <a href="https://aka.ms/acr/tiers" target="_blank" rel="noopener noreferrer"><em>Premium</em> Tier<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>ACR and AKS must be in the same region. See <a href="/acr/teleport/#preview-constraints">Project Teleport supported regions</a>.<br>
This is less of a limitation, rather a design constraint. It's always a best practice to have the content required for deployment to be within the same region. Project Teleport depends on this best practice to mount layers within an Azure network regional boundary.</li> <li>Linux containers on AKS clusters are supported. Windows support is not yet available.</li> <li>Enabling Project Teleport on an existing registry will not convert images already in the registry. To expand existing content, pull and push the image to trigger expansion.<br> <em>In a future release, enabling Project Teleport on a repository will convert the images. This work is not yet complete.</em></li> <li>ACR Geo-replicated registries are not currently supported on Project Teleport enabled registries.</li> <li><a href="https://aka.ms/acr/privatelink" target="_blank" rel="noopener noreferrer">Private Links<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> are not currently supported on Project Teleport enabled registries.</li></ul> <h3 id="enable-project-teleport-on-an-acr"><a href="#enable-project-teleport-on-an-acr" class="header-anchor">#</a> Enable Project Teleport on an ACR</h3> <p>Create a <a href="https://aka.ms/acr/tiers" target="_blank" rel="noopener noreferrer">premium instance<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of Azure Container Registry in one of the <a href="/acr/teleport/#preview-constraints">Project Teleport supported regions</a>.</p> <p>Sign up for ACR Project Teleport using <a href="https://aka.ms/acr/teleport/signup" target="_blank" rel="noopener noreferrer">the signup form<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, providing the resource ID of a <strong>Premium Tier</strong> ACR instance. Once Project Teleport is enabled, you'll receive an confirmation email.</p> <h4 id="set-environment-variables"><a href="#set-environment-variables" class="header-anchor">#</a> Set environment variables</h4> <p>Configure variables unique to your environment.</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>AKS=myaks
AKS_RG=${AKS}-rg
ACR=myacr
LOCATION=westus2
K8S_VERSION=1.19.7
ACR_URL=${ACR}.azurecr.io
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="confirming-an-acr-repository-is-set-to-expand"><a href="#confirming-an-acr-repository-is-set-to-expand" class="header-anchor">#</a> Confirming an ACR repository is set to expand</h4> <p>Once you receive a confirmation email, push an image to a new repository. You may also use <code>az acr import</code> to copy an image from another registry.</p> <p>To confirm an ACR repository has been configured for teleport expansion, use the following command, replacing <code>$ACR</code> and <code>&lt;namespace/image&gt;</code> with your acr and image name.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr import \
  --source mcr.microsoft.com/azuredocs/azure-vote-front:v1 \
  --name $ACR \
  --image azure-vote-front:v1

az acr import \
  --source mcr.microsoft.com/oss/bitnami/redis:6.0.8 \
  --name $ACR \
  --image redis:6.0.8

az acr repository show -n ${ACR} -o jsonc \
  --repository azure-vote-front
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>The following example output shows <em>&quot;teleportEnabled&quot;: true</em>, verifying Project Teleport is enabled on your ACR.</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>{
  &quot;changeableAttributes&quot;: {
    &quot;deleteEnabled&quot;: true,
    &quot;listEnabled&quot;: true,
    &quot;readEnabled&quot;: true,
    &quot;teleportEnabled&quot;: true,
    &quot;writeEnabled&quot;: true
  },
  ...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="confirming-an-image-has-been-expanded"><a href="#confirming-an-image-has-been-expanded" class="header-anchor">#</a> Confirming an image has been expanded</h4> <p>At this point in the Teleport preview, check image expansion using the <a href="./check-expansion.sh">check-expansion.sh</a> script. As the script uses a <code>/mount</code> api, basic auth is required. An <a href="https://aka.ms/acr/tokens" target="_blank" rel="noopener noreferrer">ACR Token<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is created and saved as environment variable.</p> <blockquote><p>Note: Assure <a href="./check-expansion.sh">check-expansion.sh</a> is set to execute: <code>sudo chmod +x check-expansion.sh</code></p></blockquote> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>export ACR_USER=teleport-token
export ACR_PWD=$(az acr token create \
  --name teleport-token \
  --registry $ACR \
  --scope-map _repositories_pull \
  --query credentials.passwords[0].value -o tsv)

./check-expansion.sh ${ACR} &lt;namespace/repo&gt; &lt;tag&gt;
# example: ./check-expansion.sh myacr azure-vote-front v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="install-aks-preview-cli-extension"><a href="#install-aks-preview-cli-extension" class="header-anchor">#</a> Install aks-preview CLI extension</h3> <p>To use Project Teleport with ACR and AKS, you need version 0.4.73, or greater, of the <em>aks-preview</em> CLI extension. Install the <em>aks-preview</em> Azure CLI extension using the <a href="/cli/azure/extension#az-extension-add">az extension add</a> command, or install any available updates using the <a href="/cli/azure/extension#az-extension-update">az extension update</a> command:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code># Check the current Azure CLI version
az version

# Check the current aks-preview extension version
az extension list

# Install the aks-preview extension
az extension add --name aks-preview

# Update the extension to make sure you have the latest version installed
az extension update --name aks-preview
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="register-the-aks-enableacrteleport-preview-feature"><a href="#register-the-aks-enableacrteleport-preview-feature" class="header-anchor">#</a> Register the AKS <code>EnableACRTeleport</code> preview feature</h3> <p>To use Teleport with ACR and AKS, you must enable the <code>EnableACRTeleport</code> feature flag on your subscription. This feature flag provisions the teleportd client to AKS nodes.</p> <p>Register the AKS <code>EnableACRTeleport</code> feature flag using the <a href="/cli/azure/feature#az-feature-register">az feature register</a> command as shown in the following example:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>az feature register \
  --namespace &quot;Microsoft.ContainerService&quot; \
  --name &quot;EnableACRTeleport&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>It may take 15 minutes or more to complete registration. You can check on the registration status using the <a href="/cli/azure/feature#az-feature-list">az feature list</a> command:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>az feature list \
  --query &quot;[?contains(name, 'Microsoft.ContainerService/EnableACRTeleport')].{Name:name,State:properties.state}&quot; \
  -o table
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>When ready, refresh the registration of the <em>Microsoft.ContainerService</em> resource provider using the <a href="/cli/azure/provider#az-provider-register">az provider register</a> command:</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>az provider register --namespace Microsoft.ContainerService
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="create-a-new-aks-cluster-with-teleport-enabled"><a href="#create-a-new-aks-cluster-with-teleport-enabled" class="header-anchor">#</a> Create a new AKS cluster with Teleport enabled</h2> <p>To use Teleport with ACR and AKS on a new cluster, create a new AKS cluster and specify your ACR with Project Teleport enabled as well as the <code>EnableACRTeleport=true</code> custom header.</p> <div class="language-azurecli-interactive line-numbers-mode"><pre class="language-text"><code>
# Create the AKS Cluster, attached to ACR, with Project Teleport Enabled
az aks create \
    --generate-ssh-keys \
    -g ${AKS_RG} \
    -n ${AKS} \
    --attach-acr $ACR \
    --kubernetes-version ${K8S_VERSION} \
    -l $LOCATION \
    --aks-custom-headers EnableACRTeleport=true

az aks get-credentials \
    -g ${AKS_RG} \
    -n ${AKS}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="add-a-project-teleport-enabled-node-pool-to-an-existing-aks-cluster"><a href="#add-a-project-teleport-enabled-node-pool-to-an-existing-aks-cluster" class="header-anchor">#</a> Add a Project Teleport enabled node pool to an <em>existing</em> AKS cluster</h2> <p>To use Project Teleport on an existing AKS cluster, add a node pool to your cluster and set the <code>EnableACRTeleport=true</code> custom header.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az aks nodepool add \
  --name teleportpool \
  --cluster-name ${AKS} \
  --resource-group ${AKS_RG} \
  --kubernetes-version ${K8S_VERSION} \
  --aks-custom-headers EnableACRTeleport=true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>If your AKS cluster doesn't have access to your Project Teleport enabled ACR, attach it.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az aks update \
  -n ${AKS} \
  -g ${AKS_RG} \
  --attach-acr ${ACR}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="verify-your-cluster-has-project-teleport-enabled"><a href="#verify-your-cluster-has-project-teleport-enabled" class="header-anchor">#</a> Verify your cluster has Project Teleport enabled</h2> <p>When your cluster has a node pool with Project Teleport enabled, any nodes in that node pool have the <code>kubernetes.azure.com/enable-acr-teleport-plugin:true</code> label. You can target this label with a node selector when running pods on your cluster to have specific applications take advantage of Project Teleport.</p> <p>To show the labels on your nodes, get the credentials for your cluster and use <code>kubectl</code> to show your nodes.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az aks get-credentials -g ${AKS_RG} -n ${AKS}
kubectl get nodes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Use <code>kubectl</code> to get the details of a specific node. Confirm the <code>kubernetes.azure.com/enable-acr-teleport-plugin:true</code> label appears in the node details. Note: the full name of the nodepool is not required. Only enough of the name to be unique is required.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>kubectl describe node aks-nodepool1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The following example output shows the <code>kubernetes.azure.com/enable-acr-teleport-plugin:true</code> label in the node details.</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>$ kubectl describe node aks-nodepool1-00000000-vmss000000
...
Name:               aks-nodepool1-00000000-vmss000000
Roles:              agent
Labels:             agentpool=nodepool1
                    ...
                    kubernetes.azure.com/enable-acr-teleport-plugin=true
                    ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="next-steps"><a href="#next-steps" class="header-anchor">#</a> Next steps</h2> <ul><li><a href="/acr/teleport/aks-teleport-comparison.html">Deploy two nodes, one with Project Teleport, one without to see the start time differences.</a></li></ul> <p>For more information about pushing an image into your ACR, see <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-docker-cli" target="_blank" rel="noopener noreferrer">Push your first image to a private container registry using the Docker CLI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>For more information about importing images into your ACR, see <a href="https://aka.ms/acr/import" target="_blank" rel="noopener noreferrer">Import container images to a container registry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azure/acr/edit/master/docs/teleport/aks-getting-started.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/acr/assets/js/app.3ca3959d.js" defer></script><script src="/acr/assets/js/2.4abe739f.js" defer></script><script src="/acr/assets/js/57.0266cf09.js" defer></script>
  </body>
</html>
