(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{460:function(s,a,t){"use strict";t.r(a);var e=t(65),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"azure-container-registry-integration-with-azure-active-directory"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#azure-container-registry-integration-with-azure-active-directory"}},[s._v("#")]),s._v(" Azure Container Registry integration with Azure Active Directory")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#azure-container-registry-integration-with-azure-active-directory"}},[s._v("Azure Container Registry integration with Azure Active Directory")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#overview"}},[s._v("Overview")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#authenticating-to-a-registry-with-azure-cli"}},[s._v("Authenticating to a registry with Azure CLI")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#listing-a-repository-with-azure-cli"}},[s._v("Listing a repository with Azure CLI")])])])]),s._v(" "),t("li",[t("a",{attrs:{href:"#azure-container-registry-token-claim-sets"}},[s._v("Azure Container Registry token claim sets")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#getting-credentials-programmatically"}},[s._v("Getting credentials programmatically")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#calling-post-oauth2exchange-to-get-an-acr-refresh-token"}},[s._v("Calling "),t("code",[s._v("POST /oauth2/exchange")]),s._v(" to get an ACR refresh token")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#authenticating-docker-with-an-acr-refresh-token"}},[s._v("Authenticating docker with an ACR refresh token")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#calling-post-oauth2token-to-get-an-acr-access-token"}},[s._v("Calling "),t("code",[s._v("POST /oauth2/token")]),s._v(" to get an ACR access token")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#calling-post-oauth2token-to-get-an-acr-access-token-for-helm-repository"}},[s._v("Calling "),t("code",[s._v("POST /oauth2/token")]),s._v(" to get an ACR access token for Helm repository")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#calling-an-azure-container-registry-api"}},[s._v("Calling an Azure Container Registry API")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#catalog-listing"}},[s._v("Catalog Listing")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#pagination"}},[s._v("Pagination")])])])]),s._v(" "),t("li",[t("a",{attrs:{href:"#tag-listing"}},[s._v("Tag Listing")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#pagination-1"}},[s._v("Pagination")])])])])])]),s._v(" "),t("li",[t("a",{attrs:{href:"#samples-api-call-scripts"}},[s._v("Samples API Call scripts")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#catalog-listing-with-aad-refresh-token"}},[s._v("Catalog Listing with AAD refresh token")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#catalog-listing-using-spadmin-with-basic-auth"}},[s._v("Catalog listing using SP/Admin with Basic Auth")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#catalog-listing-using-admin-keys-with-bearer-auth"}},[s._v("Catalog listing using Admin Keys with Bearer Auth")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#docker-login-with-acr-access-token---single-repository-scope"}},[s._v("Docker login with ACR Access Token - Single repository scope")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#fetch-helm-indexyaml-with-admin-keys-or-sp-with-basic-auth"}},[s._v("Fetch helm index.yaml with Admin Keys or SP with Basic Auth")])])])])])])]),s._v(" "),t("h2",{attrs:{id:"overview"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#overview"}},[s._v("#")]),s._v(" Overview")]),s._v(" "),t("p",[s._v("The Azure Container Registry allows users to manage a private Docker registry on the cloud. Our service enables customers to store and manage container images across all types of Azure deployments, keep container images near deployments to reduce latency and costs, maintain Windows and Linux container images in a single Docker registry, use familiar, open-source Docker command line interface (CLI) tools, and simplify registry access management with Azure Active Directory.")]),s._v(" "),t("p",[s._v("The integration of Azure Container Registry with Azure Active Directory is crucial in order to enable transparent authentication and authorization of users and headless services using AAD credentials. In this scenario, a user will only have to use their AAD credentials to log-in to their private registry, and the Azure Container Service will take care of the authorization validation of each operation using the provided credentials.")]),s._v(" "),t("p",[s._v("Under the hood Azure Container Service utilizes the "),t("a",{attrs:{href:"https://oauth.net/2/",target:"_blank",rel:"noopener noreferrer"}},[s._v("oauth2"),t("OutboundLink")],1),s._v(" authorization protocol, as described by the "),t("a",{attrs:{href:"https://docs.docker.com/registry/spec/auth/token/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Registry v2 authentication via central service documentation"),t("OutboundLink")],1),s._v(" as well as the "),t("a",{attrs:{href:"https://docs.docker.com/registry/spec/auth/jwt/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Registry v2 Bearer token specification"),t("OutboundLink")],1),s._v(". The JWT tokens generated by the Azure Container Registry are easy to observe in "),t("a",{attrs:{href:"https://jwt.ms/",target:"_blank",rel:"noopener noreferrer"}},[s._v("jwt.ms"),t("OutboundLink")],1),s._v(".")]),s._v(" "),t("h2",{attrs:{id:"authenticating-to-a-registry-with-azure-cli"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#authenticating-to-a-registry-with-azure-cli"}},[s._v("#")]),s._v(" Authenticating to a registry with Azure CLI")]),s._v(" "),t("p",[s._v("The process to log in to the registry, from the user's perspective, is simple. The user will use the Microsoft Azure CLI 2.0:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("az acr login -n contosoregistry\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Internally, the CLI will follow these steps:")]),s._v(" "),t("ol",[t("li",[s._v("Calls to Azure Resource Manager to resolve the login server for the specified registry.")]),s._v(" "),t("li",[s._v("Obtains refresh credentials from the profile in use. For a headless call, this will give you the registered SPN, for a regular user this will give you a refresh token.")]),s._v(" "),t("li",[s._v("Makes an HTTPS GET call to the registry server's "),t("code",[s._v("/v2")]),s._v(" endpoint, without credentials. A bearer token authentication challenge is expected, specifying realm and service values. The realm contains the authentication server's URL.")]),s._v(" "),t("li",[s._v("Makes an HTTPS POST call to the authentication server's "),t("code",[s._v("POST /oauth2/exchange")]),s._v(" endpoint, with a body indicating the grant type, the service, the tenant, and the credentials.")]),s._v(" "),t("li",[s._v("From the server's response, we extract an Azure Container Registry refresh token.")]),s._v(" "),t("li",[s._v("Pass the refresh token as the password to the Docker CLI, using a null GUID as the username and calling "),t("code",[s._v("docker login")]),s._v(". From here on, the docker CLI takes care of the authorization cycle using oauth2.")])]),s._v(" "),t("p",[s._v("At the end Docker will store the refresh token and go through the oauth2 flow on each operation it does against the Azure Container Registry.")]),s._v(" "),t("h2",{attrs:{id:"listing-a-repository-with-azure-cli"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#listing-a-repository-with-azure-cli"}},[s._v("#")]),s._v(" Listing a repository with Azure CLI")]),s._v(" "),t("p",[s._v("The Microsoft Azure CLI 2.0 allows users to also list the repositories registries, and list tags for a repository in a registry. Here's how users can achieve listing the repositories in a registry:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("az acr repository list -n contosoregistry\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Internally, the CLI will follow these steps:")]),s._v(" "),t("ol",[t("li",[s._v("Calls to Azure Resource Manager to resolve the login server for the specified registry.")]),s._v(" "),t("li",[s._v("Obtains refresh credentials from the profile in use. For a headless call, this will give you the registered SPN, for a regular user this will give you a refresh token.")]),s._v(" "),t("li",[s._v("Makes an HTTPS GET call to the registry server's "),t("code",[s._v("/v2")]),s._v(" endpoint, without credentials. A bearer token authentication challenge is expected, specifying realm and service values. The realm contains the authentication server's URL.")]),s._v(" "),t("li",[s._v("Makes an HTTPS POST call to the authentication server's "),t("code",[s._v("POST /oauth2/exchange")]),s._v(" endpoint, with a body indicating the grant type, the service, the tenant, and the credentials.")]),s._v(" "),t("li",[s._v("From the server's response we extract an Azure Container Registry refresh token.")]),s._v(" "),t("li",[s._v("Makes an HTTPS POST call to the authentication server's "),t("code",[s._v("POST /oauth2/token")]),s._v(" endpoint, with a body indicating the grant type, the service, the scope, and the Azure Container Registry refresh token.")]),s._v(" "),t("li",[s._v("From the server's response we extract an Azure Container Registry access token.")]),s._v(" "),t("li",[s._v("Makes an HTTPS GET call to the registry server's "),t("code",[s._v("GET /v2/_catalog")]),s._v(" endpoint using the access token as the bearer token.")]),s._v(" "),t("li",[s._v("Obtains the data from the service and displays it.")])]),s._v(" "),t("p",[s._v("When listing the tags of a repository, every step above is the same except for the call to the endpoint that gives the tags which is "),t("code",[s._v("GET /v2/contosoregistry/tags/list")]),s._v(" instead of "),t("code",[s._v("GET /v2/_catalog")]),s._v(".")]),s._v(" "),t("h1",{attrs:{id:"azure-container-registry-token-claim-sets"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#azure-container-registry-token-claim-sets"}},[s._v("#")]),s._v(" Azure Container Registry token claim sets")]),s._v(" "),t("p",[s._v("Following the command of repository list in the previous section:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("az acr repository list -n contosoregistry\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("A JWT refresh token extracted at step 5 has the following claim set:")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"jti"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"365e3b5b-844e-4a21-a38c-4d8aebdd6a06"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"sub"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user@contoso.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"nbf"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1497988712")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"exp"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1497990801")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"iat"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1497988712")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"iss"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Azure Container Registry"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"aud"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"grant_type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"refresh_token"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"tenant"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"409520d4-8100-4d1d-ad47-72432ddcc120"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"permissions"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"actions"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"notActions"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"roles"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("Followed by an access token at step 7 with the following claim set:")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"jti"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ec425c1e-7eda-4f70-adb5-19f927e34a41"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"sub"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user@contoso.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"nbf"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1497988907")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"exp"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1497993407")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"iat"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1497988907")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"iss"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Azure Container Registry"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"aud"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"access"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"catalog"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"actions"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"roles"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"grant_type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"access_token"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("h1",{attrs:{id:"getting-credentials-programmatically"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#getting-credentials-programmatically"}},[s._v("#")]),s._v(" Getting credentials programmatically")]),s._v(" "),t("p",[s._v("In order to sign in to a container you'll need to exchange AAD credentials for ACR credentials. The accepted form of credential exchange are:")]),s._v(" "),t("ul",[t("li",[s._v("AAD access token.")]),s._v(" "),t("li",[s._v("[Deprecated] AAD refresh token.")]),s._v(" "),t("li",[s._v("[Deprecated] AAD access token and refresh token.")])]),s._v(" "),t("p",[s._v("The AAD access token is used to talk to the Azure Resource Manager and query for the set of permissions that the user has for the container registry resource.")]),s._v(" "),t("p",[s._v("[Deprecated] The AAD refresh token is used in two ways:")]),s._v(" "),t("ol",[t("li",[s._v("If no AAD access token was presented, the AAD refresh token is used to obtain an AAD access token.")]),s._v(" "),t("li",[s._v("The AAD refresh token is sent back to the user so they can initiate a token refresh cycle against AAD. If no AAD refresh token is sent, then the client won't have this credential at hand to initiate a credential refresh.")])]),s._v(" "),t("p",[s._v("The cycle to get credentials looks as follows:")]),s._v(" "),t("ol",[t("li",[s._v("Call "),t("code",[s._v("POST /oauth2/exchange")]),s._v(" presenting the AAD access token or the AAD refresh token [Deprecated]. The service will return you an ACR refresh token.")]),s._v(" "),t("li",[s._v("Call "),t("code",[s._v("POST /oauth2/token")]),s._v(" presenting the ACR refresh token. The service will return you an ACR access token which you can use to call the Azure Container Registry's APIs.")])]),s._v(" "),t("h2",{attrs:{id:"calling-post-oauth2-exchange-to-get-an-acr-refresh-token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#calling-post-oauth2-exchange-to-get-an-acr-refresh-token"}},[s._v("#")]),s._v(" Calling "),t("code",[s._v("POST /oauth2/exchange")]),s._v(" to get an ACR refresh token")]),s._v(" "),t("p",[s._v("In this example, we'll try to obtain an ACR refresh token from existing AAD tokens. Assume you have the following:")]),s._v(" "),t("ol",[t("li",[s._v("A valid container registry, which here we'll call "),t("code",[s._v("contosoregistry.azurecr.io")]),s._v(".")]),s._v(" "),t("li",[s._v("The AAD tenant identifier associated to the credentials, which here we'll take to be "),t("code",[s._v("409520d4-8100-4d1d-ad47-72432ddcc120")]),s._v(".")]),s._v(" "),t("li",[s._v("Valid AAD access token credential with access to the aforementioned container registry.")])]),s._v(" "),t("p",[s._v("The AAD access token can be obtained from the Azure CLI. After running "),t("code",[s._v("az login")]),s._v(" check file "),t("code",[s._v("$HOME/.azure/accessTokens.json")]),s._v(" ("),t("code",[s._v("%HOMEDRIVE%%HOMEPATH%\\.azure\\accessTokens.json")]),s._v(" in Windows) for the token values.")]),s._v(" "),t("p",[s._v("We'll now call "),t("code",[s._v("POST /oauth2/exchange")]),s._v(" to exchange the AAD tokens for an ACR refresh token. Here's how such a call looks when done via "),t("code",[s._v("curl")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tenant")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"409520d4-8100-4d1d-ad47-72432ddcc120"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("aad_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...H-g"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -X POST -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" -d "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grant_type=access_token&service='),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("&tenant="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$tenant")]),s._v("&access_token="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$aad_access_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    https://"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/oauth2/exchange\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("The body of the POST message is a querystring-like text that specifies the following values:")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("grant_type")]),s._v(", which can take a value of "),t("code",[s._v("access_token")]),s._v(", or "),t("code",[s._v("access_token_refresh_token")]),s._v(" [Deprecated], or "),t("code",[s._v("refresh_token")]),s._v(" [Deprecated].")]),s._v(" "),t("li",[t("code",[s._v("service")]),s._v(", which must indicate the name of your Azure container registry.")]),s._v(" "),t("li",[t("code",[s._v("tenant")]),s._v(", which is the AAD tenant associated to the AAD credentials.")]),s._v(" "),t("li",[t("code",[s._v("access_token")]),s._v(", the AAD access token, mandatory when "),t("code",[s._v("grant_type")]),s._v(" is "),t("code",[s._v("access_token")]),s._v(" or "),t("code",[s._v("access_token_refresh_token")]),s._v(" [Deprecated].")]),s._v(" "),t("li",[s._v("[Deprecated] "),t("code",[s._v("refresh_token")]),s._v(", the AAD refresh token, mandatory when "),t("code",[s._v("grant_type")]),s._v(" is "),t("code",[s._v("access_token_refresh_token")]),s._v(" or "),t("code",[s._v("refresh_token")]),s._v(".")])]),s._v(" "),t("p",[s._v("The outcome of this operation will be a response with status 200 OK and a body with the following JSON payload:")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"refresh_token"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...L7a"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("This response is the ACR refresh token which you can inspect with "),t("a",{attrs:{href:"https://jwt.ms/",target:"_blank",rel:"noopener noreferrer"}},[s._v("jwt.ms"),t("OutboundLink")],1),s._v(". You can now use it to obtain an ACR access token programmatically or simply send it to the "),t("code",[s._v("docker login")]),s._v(" command to get docker talking to the Azure Container Registry.")]),s._v(" "),t("h2",{attrs:{id:"authenticating-docker-with-an-acr-refresh-token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#authenticating-docker-with-an-acr-refresh-token"}},[s._v("#")]),s._v(" Authenticating docker with an ACR refresh token")]),s._v(" "),t("p",[s._v("Once you have obtained an ACR refresh token, you can use the docker CLI to sign in to your registry like this:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"00000000-0000-0000-0000-000000000000"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_refresh_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...L7a"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" login -u "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_username")]),s._v('"')]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_refresh_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("The null GUID tells the container registry that this is an ACR refresh token during the login flow. Once the authentication succeeds you can talk to the Azure Container Registry with commands like "),t("code",[s._v("docker pull")]),s._v(" and "),t("code",[s._v("docker push")]),s._v(". For example:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" pull contosoregistry.azurecr.io/contoso-marketing\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Notice that the ACR refresh token will be saved by the docker CLI in its credential store, and will be used by the docker CLI to obtain an ACR access token on each operation it performs against the Azure Container Registry. The ACR refresh token is made so it stops working after a period of time, but if you obtained it using either "),t("code",[s._v("grant_type=access_token_refresh_token")]),s._v(" or "),t("code",[s._v("grant_type=refresh_token")]),s._v(" then it can be refreshed automatically by installing the "),t("a",{attrs:{href:"https://github.com/azure/acr-docker-credential-helper",target:"_blank",rel:"noopener noreferrer"}},[s._v("ACR docker credential helper"),t("OutboundLink")],1),s._v(".")]),s._v(" "),t("h2",{attrs:{id:"calling-post-oauth2-token-to-get-an-acr-access-token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#calling-post-oauth2-token-to-get-an-acr-access-token"}},[s._v("#")]),s._v(" Calling "),t("code",[s._v("POST /oauth2/token")]),s._v(" to get an ACR access token")]),s._v(" "),t("p",[s._v("In this example, we'll try to obtain an ACR access token from existing ACR refresh token, and this access token will only work for the operation we're trying to perform, which is a call to the "),t("code",[s._v("GET /v2/_catalog")]),s._v(" API. Assume you have the following:")]),s._v(" "),t("ol",[t("li",[s._v("A valid container registry, which here we'll call "),t("code",[s._v("contosoregistry.azurecr.io")]),s._v(".")]),s._v(" "),t("li",[s._v("A valid ACR refresh token.")])]),s._v(" "),t("p",[s._v("The first thing you want is to obtain an authentication challenge for the operation you want to on the Azure Container Registry. That can be done by targetting the API you want to call without any authentication. Here's how to do that via "),t("code",[s._v("curl")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v https://"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/v2/_catalog\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("Note that "),t("code",[s._v("curl")]),s._v(" by default does the request as a "),t("code",[s._v("GET")]),s._v(" unless you specify a different verb with the "),t("code",[s._v("-X")]),s._v(" modifier.")]),s._v(" "),t("p",[s._v("This will output the following payload, with "),t("code",[s._v("...")]),s._v(" used to shorten it for illustrative purposes:")]),s._v(" "),t("div",{staticClass:"language-html line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-html"}},[t("code",[s._v('< HTTP/1.1 401 Unauthorized\n...\n< Www-Authenticate: Bearer realm="https://contosoregistry.azurecr.io/oauth2/token",service="contosoregistry.azurecr.io",scope="registry:catalog:*"\n...\n{"errors":[{"code":"UNAUTHORIZED","message":"authentication required","detail":[{"Type":"registry","Name":"catalog","Action":"*"}]}]}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("Notice the response payload has a header called "),t("code",[s._v("Www-Authenticate")]),s._v(" that gives us the following information:")]),s._v(" "),t("ul",[t("li",[s._v("The type of challenge: "),t("code",[s._v("Bearer")]),s._v(".")]),s._v(" "),t("li",[s._v("The realm of the challenge: "),t("code",[s._v("https://contosoregistry.azurecr.io/oauth2/token")]),s._v(".")]),s._v(" "),t("li",[s._v("The service of the challenge: "),t("code",[s._v("contosoregistry.azurecr.io")]),s._v(".")]),s._v(" "),t("li",[s._v("The scope of the challenge: "),t("code",[s._v("registry:catalog:*")]),s._v(".")])]),s._v(" "),t("p",[s._v("The body of the payload might provide additional details, but all the information you need is contained in the "),t("code",[s._v("Www-Authenticate")]),s._v(" header.")]),s._v(" "),t("p",[s._v("With this information we're now ready to call "),t("code",[s._v("POST /oauth2/token")]),s._v(" to obtain an ACR access token that will allow us to use the "),t("code",[s._v("GET /v2/_catalog")]),s._v(" API. Here's how such a call looks when done via "),t("code",[s._v("curl")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_refresh_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...L7a"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("scope")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry:catalog:*"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -X POST -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" -d "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grant_type=refresh_token&service='),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("&scope="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scope")]),s._v("&refresh_token="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_refresh_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nhttps://"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/oauth2/token\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("The body of the POST message is a querystring-like text that specifies the following values:")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("grant_type")]),s._v(" which is expected to be "),t("code",[s._v("refresh_token")]),s._v(".")]),s._v(" "),t("li",[t("code",[s._v("service")]),s._v(", which must indicate the name of your Azure container registry. You obtained this from the "),t("code",[s._v("Www-Authenticate")]),s._v(" response header from the challenge.")]),s._v(" "),t("li",[t("code",[s._v("scope")]),s._v(", which is expected to be a valid "),t("a",{attrs:{href:"https://docs.docker.com/registry/spec/auth/scope/",target:"_blank",rel:"noopener noreferrer"}},[s._v("scope"),t("OutboundLink")],1),s._v(", and can be specified more than once for multiple scope requests. You obtained this from the "),t("code",[s._v("Www-Authenticate")]),s._v(" response header from the challenge.")]),s._v(" "),t("li",[t("code",[s._v("refresh_token")]),s._v(", which must be a valid ACR refresh token, as obtained by calling "),t("code",[s._v("POST /oauth2/exchange")]),s._v(".")])]),s._v(" "),t("p",[s._v("The outcome of this operation will be a response with status 200 OK and a body with the following JSON payload:")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"access_token"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...xcg"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("This response is the ACR access token which you can inspect with "),t("a",{attrs:{href:"https://jwt.ms/",target:"_blank",rel:"noopener noreferrer"}},[s._v("jwt.ms"),t("OutboundLink")],1),s._v(". You can now use it to call APIs exposed by the Azure Container Registry")]),s._v(" "),t("h2",{attrs:{id:"calling-post-oauth2-token-to-get-an-acr-access-token-for-helm-repository"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#calling-post-oauth2-token-to-get-an-acr-access-token-for-helm-repository"}},[s._v("#")]),s._v(" Calling "),t("code",[s._v("POST /oauth2/token")]),s._v(" to get an ACR access token for Helm repository")]),s._v(" "),t("p",[s._v("In this example, we'll try to obtain an ACR access token from existing ACR refresh token to access Helm repository, and this access token will only work for the operation we're trying to perform, which is a call to the "),t("code",[s._v("GET /helm/v1/repo/index.yaml")]),s._v(" API. Assume you have the following:")]),s._v(" "),t("ol",[t("li",[s._v("A valid container registry, which here we'll call "),t("code",[s._v("contosoregistry.azurecr.io")]),s._v(".")]),s._v(" "),t("li",[s._v("A valid ACR refresh token.")])]),s._v(" "),t("p",[s._v("The first thing you want is to obtain an authentication challenge for the operation you want to on the Azure Container Registry. That can be done by targetting the API you want to call without any authentication. Here's how to do that via "),t("code",[s._v("curl")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v https://"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/helm/v1/repo/index.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("Note that "),t("code",[s._v("curl")]),s._v(" by default does the request as a "),t("code",[s._v("GET")]),s._v(" unless you specify a different verb with the "),t("code",[s._v("-X")]),s._v(" modifier.")]),s._v(" "),t("p",[s._v("This will output the following payload, with "),t("code",[s._v("...")]),s._v(" used to shorten it for illustrative purposes:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" HTTP/1.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("401")]),s._v(" Unauthorized\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Www-Authenticate: Bearer "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://contosoregistry.azurecr.io/oauth2/token"')]),s._v(",service"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v(",scope"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artifact-repository:repo:pull"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"errors"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"code"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"UNAUTHORIZED"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authentication required"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"detail"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Type"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artifact-repository"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Name"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"repo"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Action"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pull"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("Notice the response payload has a header called "),t("code",[s._v("Www-Authenticate")]),s._v(" that gives us the following information:")]),s._v(" "),t("ul",[t("li",[s._v("The type of challenge: "),t("code",[s._v("Bearer")]),s._v(".")]),s._v(" "),t("li",[s._v("The realm of the challenge: "),t("code",[s._v("https://contosoregistry.azurecr.io/oauth2/token")]),s._v(".")]),s._v(" "),t("li",[s._v("The service of the challenge: "),t("code",[s._v("contosoregistry.azurecr.io")]),s._v(".")]),s._v(" "),t("li",[s._v("The scope of the challenge: "),t("code",[s._v("artifact-repository:repo:pull")]),s._v(".")])]),s._v(" "),t("p",[s._v("The body of the payload might provide additional details, but all the information you need is contained in the "),t("code",[s._v("Www-Authenticate")]),s._v(" header.")]),s._v(" "),t("p",[s._v("With this information we're now ready to call "),t("code",[s._v("POST /oauth2/token")]),s._v(" to obtain an ACR access token that will allow us to use the "),t("code",[s._v("GET /helm/v1/repo/index.yaml")]),s._v(" API. Here's how such a call looks when done via "),t("code",[s._v("curl")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_refresh_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...L7a"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("scope")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"artifact-repository:repo:pull"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -X POST -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" -d "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grant_type=refresh_token&service='),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("&scope="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scope")]),s._v("&refresh_token="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_refresh_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nhttps://"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/oauth2/token\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("The body of the POST message is a querystring-like text that specifies the following values:")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("grant_type")]),s._v(" which is expected to be "),t("code",[s._v("refresh_token")]),s._v(".")]),s._v(" "),t("li",[t("code",[s._v("service")]),s._v(", which must indicate the name of your Azure container registry. You obtained this from the "),t("code",[s._v("Www-Authenticate")]),s._v(" response header from the challenge.")]),s._v(" "),t("li",[t("code",[s._v("scope")]),s._v(", which is expected to be a "),t("code",[s._v("artifact-repository:repo:pull")]),s._v(" for read operations and "),t("code",[s._v("artifact-repository:repo:*")]),s._v(" for write operations, and can be specified more than once for multiple scope requests. You obtained this from the "),t("code",[s._v("Www-Authenticate")]),s._v(" response header from the challenge.")]),s._v(" "),t("li",[t("code",[s._v("refresh_token")]),s._v(", which must be a valid ACR refresh token, as obtained by calling "),t("code",[s._v("POST /oauth2/exchange")]),s._v(".")])]),s._v(" "),t("p",[s._v("The outcome of this operation will be a response with status 200 OK and a body with the following JSON payload:")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"access_token"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...xcg"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("This response is the ACR access token which you can inspect with "),t("a",{attrs:{href:"https://jwt.ms/",target:"_blank",rel:"noopener noreferrer"}},[s._v("jwt.ms"),t("OutboundLink")],1),s._v(". You can now use it to call APIs exposed by the Azure Container Registry. Refer the full script to "),t("a",{attrs:{href:"#fetch-helm-indexyaml"}},[s._v("fetch the helm index.yaml")]),s._v(".")]),s._v(" "),t("h2",{attrs:{id:"calling-an-azure-container-registry-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#calling-an-azure-container-registry-api"}},[s._v("#")]),s._v(" Calling an Azure Container Registry API")]),s._v(" "),t("p",[s._v("In this example we'll call catalog listing and tag listing APIs on an Azure Container Registry.")]),s._v(" "),t("h3",{attrs:{id:"catalog-listing"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#catalog-listing"}},[s._v("#")]),s._v(" Catalog Listing")]),s._v(" "),t("p",[s._v("Assume you have the following:")]),s._v(" "),t("ol",[t("li",[s._v("A valid container registry, which here we'll call "),t("code",[s._v("contosoregistry.azurecr.io")]),s._v(".")]),s._v(" "),t("li",[s._v("A valid ACR access token, created with the correct scope for the API we're going to call.")])]),s._v(" "),t("p",[s._v("Here's how a call to the "),t("code",[s._v("GET /v2/_catalog")]),s._v(" API of the given registry would look like when done via "),t("code",[s._v("curl")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...xcg"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" https://"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/v2/_catalog\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("Note that "),t("code",[s._v("curl")]),s._v(" by default does the request as a "),t("code",[s._v("GET")]),s._v(" unless you specify a different verb with the "),t("code",[s._v("-X")]),s._v(" modifier.")]),s._v(" "),t("p",[s._v("This should result in a status 200 OK, and a body with a JSON payload listing the repositories held in this registry:")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"repositories"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alpine"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contoso-marketing"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello-world"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"pagination"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pagination"}},[s._v("#")]),s._v(" Pagination")]),s._v(" "),t("p",[s._v("To retrieve paginated catalog results, add an "),t("code",[s._v("n")]),s._v(" parameter to limit the number or results. We take "),t("code",[s._v("n=2")]),s._v(" as example:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...xcg"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("limit")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/v2/_catalog?n="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$limit")]),s._v('"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("This should result in a status 200 OK, and a body with a JSON payload listing the first "),t("code",[s._v("n")]),s._v(" repositories held in this registry. If there are more results, a "),t("code",[s._v("Link")]),s._v(" header containing the request URL for the next result block is also returned.  If the entire result set has been received, the "),t("code",[s._v("Link")]),s._v(" header will not be returned.")]),s._v(" "),t("p",[s._v("In this case, the first 2 repositories are returned, and there are more entries in the result set. The response would look like:")]),s._v(" "),t("div",{staticClass:"language-http line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-http"}},[t("code",[s._v("< HTTP/1.1 200 OK\n...\n"),t("span",{pre:!0,attrs:{class:"token header"}},[t("span",{pre:!0,attrs:{class:"token header-name keyword"}},[s._v("Content-Type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token header-value"}},[s._v("application/json")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token header"}},[t("span",{pre:!0,attrs:{class:"token header-name keyword"}},[s._v("Link")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token header-value"}},[s._v('</v2/_catalog?last=contoso-marketing&n=2&orderby=>; rel="next"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token application-json"}},[s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"repositories"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alpine"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contoso-marketing"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("To get the next result block, issue the request using the "),t("code",[s._v("/v2/_catalog?last=contoso-marketing&n=2&orderby=")]),s._v(" URL encoded in the "),t("code",[s._v("Link")]),s._v(" header. Here is how the call would look like:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v('/v2/_catalog?last=contoso-marketing&n=2&orderby="')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("You can query the paginated results in a loop, as the following shows:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...xcg"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("limit")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/v2/_catalog?n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$limit")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("headers")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("mktemp -t headers.XXXXX"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$operation")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Operation"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$operation")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("catalog")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$operation")]),s._v('"')]),s._v(" -D $headers"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Catalog"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$catalog")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" $headers "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^Link: <\\(.*\\)>.*/\\1/p'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$headers")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("For more information, visit "),t("a",{attrs:{href:"https://docs.docker.com/registry/spec/api/#listing-repositories",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker V2 API Reference - Listing Repositories"),t("OutboundLink")],1),s._v(".")]),s._v(" "),t("h3",{attrs:{id:"tag-listing"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tag-listing"}},[s._v("#")]),s._v(" Tag Listing")]),s._v(" "),t("p",[s._v("Assume you have the following:")]),s._v(" "),t("ol",[t("li",[s._v("A valid container registry, which here we'll call "),t("code",[s._v("contosoregistry.azurecr.io")]),s._v(".")]),s._v(" "),t("li",[s._v("A valid ACR access token, created with the correct scope for the API we're going to call.")]),s._v(" "),t("li",[s._v("A valid image in the registry, for example "),t("code",[s._v("hello-world")]),s._v(".")])]),s._v(" "),t("p",[s._v("Here's how a call to the "),t("code",[s._v("GET /v2/<name>/tags/list")]),s._v(" API of the given image would look like when done via "),t("code",[s._v("curl")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...xcg"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello-world"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/v2/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image")]),s._v('/tags/list"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("Note that "),t("code",[s._v("curl")]),s._v(" by default does the request as a "),t("code",[s._v("GET")]),s._v(" unless you specify a different verb with the "),t("code",[s._v("-X")]),s._v(" modifier.")]),s._v(" "),t("p",[s._v("This should result in a status 200 OK, and a body with a JSON payload listing the tags of this image:")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello-world"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"tags"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"latest"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v2"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v3"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"pagination-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pagination-2"}},[s._v("#")]),s._v(" Pagination")]),s._v(" "),t("p",[s._v("To retrieve paginated tag results, add an "),t("code",[s._v("n")]),s._v(" parameter to limit the number or results. We take "),t("code",[s._v("n=2")]),s._v(" as example:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...xcg"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello-world"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("limit")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/v2/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image")]),s._v("/tags/list?n="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$limit")]),s._v('"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("This should result in a status 200 OK, and a body with a JSON payload listing the first "),t("code",[s._v("n")]),s._v(" tags of this image. If there are more results, a "),t("code",[s._v("Link")]),s._v(" header containing the request URL for the next result block is also returned.  If the entire result set has been received, the "),t("code",[s._v("Link")]),s._v(" header will not be returned.")]),s._v(" "),t("p",[s._v("In this case, the first 2 tags are returned, and there are more entries in the result set. The response would look like:")]),s._v(" "),t("div",{staticClass:"language-http line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-http"}},[t("code",[s._v("< HTTP/1.1 200 OK\n...\n"),t("span",{pre:!0,attrs:{class:"token header"}},[t("span",{pre:!0,attrs:{class:"token header-name keyword"}},[s._v("Content-Type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token header-value"}},[s._v("application/json")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token header"}},[t("span",{pre:!0,attrs:{class:"token header-name keyword"}},[s._v("Link")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token header-value"}},[s._v('</v2/hello-world/tags/list?last=v1&n=2&orderby=>; rel="next"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token application-json"}},[s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello-world"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"tags"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"latest"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("To get the next result block, issue the request using the "),t("code",[s._v("/v2/hello-world/tags/list?last=v1&n=2&orderby=")]),s._v(" URL encoded in the "),t("code",[s._v("Link")]),s._v(" header. Here is how the call would look like:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/v2/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image")]),s._v('/tags/list?last=v1&n=2&orderby="')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("You can query the paginated results in a loop, as the following shows:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contosoregistry.azurecr.io"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eyJ...xcg"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello-world"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("limit")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/v2/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image")]),s._v("/tags/list?n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$limit")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("headers")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("mktemp -t headers.XXXXX"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$operation")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Operation"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$operation")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tags")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$operation")]),s._v('"')]),s._v(" -D $headers"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Tags"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$tags")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" $headers "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^Link: <\\(.*\\)>.*/\\1/p'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$headers")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("For more information, visit "),t("a",{attrs:{href:"https://docs.docker.com/registry/spec/api/#listing-image-tags",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker V2 API Reference - Listing Image Tags"),t("OutboundLink")],1),s._v(".")]),s._v(" "),t("h2",{attrs:{id:"samples-api-call-scripts"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#samples-api-call-scripts"}},[s._v("#")]),s._v(" Samples API Call scripts")]),s._v(" "),t("p",[s._v("This is a summary script of the points discussed above. The first three variables have to be filled out.")]),s._v(" "),t("ul",[t("li",[s._v("Variable "),t("code",[s._v("registry")]),s._v(" can be something like "),t("code",[s._v('"contosoregistry.azurecr.io"')]),s._v(".")]),s._v(" "),t("li",[s._v("The AAD access token and AAD refresh token values can be obtained from the Azure CLI, after running "),t("code",[s._v("az login")]),s._v(" check file "),t("code",[s._v("$HOME/.azure/accessTokens.json")]),s._v(" ("),t("code",[s._v("%HOMEDRIVE%%HOMEPATH%\\.azure\\accessTokens.json")]),s._v(" in Windows) for the token values.")])]),s._v(" "),t("p",[s._v("Note that a stale AAD tokens will result in this script failing to obtain an ACR refresh token, and therefore it won't succeed in obtaining an ACR access token or in executing the operation against the registry.")]),s._v(" "),t("h3",{attrs:{id:"catalog-listing-with-aad-refresh-token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#catalog-listing-with-aad-refresh-token"}},[s._v("#")]),s._v(" Catalog Listing with AAD refresh token")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("aad_refresh_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("aad_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/v2/_catalog"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_refresh_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -X POST -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grant_type=access_token_refresh_token&service='),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("&refresh_token="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$aad_refresh_token")]),s._v("&access_token="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$aad_access_token")]),s._v('"')]),s._v(" https://$registry/oauth2/exchange "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.refresh_token'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ACR Refresh Token"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_refresh_token")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("challenge")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -vs https://$registry$operation "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Www-Authenticate:"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Challenge"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$challenge")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("scope")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" $challenge "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'scope=\\"([^\\"]*)\\"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\\"([^\\"]*)\\"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Scope"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scope")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -X POST -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grant_type=refresh_token&service='),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("&scope="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scope")]),s._v("&refresh_token="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_refresh_token")]),s._v('"')]),s._v(" https://$registry/oauth2/token "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.access_token'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ACR Access Token"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("catalog")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" https://$registry$operation"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Catalog"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$catalog")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br")])]),t("h3",{attrs:{id:"catalog-listing-using-sp-admin-with-basic-auth"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#catalog-listing-using-sp-admin-with-basic-auth"}},[s._v("#")]),s._v(" Catalog listing using SP/Admin with Basic Auth")]),s._v(" "),t("p",[s._v("Here's an equivalent set of scripts that will allow you to execute an operation against an Azure Container Registry, but this time using only the admin credentials, and not AAD.")]),s._v(" "),t("p",[s._v("If you'd like to use basic auth, you can do a direct call to the registry like this:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/v2/_catalog"')]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("credentials")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$user")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$password")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 -w "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("catalog")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Basic '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$credentials")]),s._v('"')]),s._v(" https://$registry$operation"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Catalog"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$catalog")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("h3",{attrs:{id:"catalog-listing-using-admin-keys-with-bearer-auth"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#catalog-listing-using-admin-keys-with-bearer-auth"}},[s._v("#")]),s._v(" Catalog listing using Admin Keys with Bearer Auth")]),s._v(" "),t("p",[s._v("If you'd like to use bearer auth, you have to first convert your admin credentials to an ACR access token like this:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/v2/_catalog"')]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("challenge")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -vs https://$registry$operation "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Www-Authenticate:"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Challenge"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$challenge")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("scope")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" $challenge "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'scope=\\"([^\\"]*)\\"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\\"([^\\"]*)\\"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Scope"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scope")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("credentials")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$user")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$password")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 -w "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Basic '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$credentials")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/oauth2/token?service="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("&scope="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scope")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.access_token'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ACR Access Token"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("catalog")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" https://$registry$operation"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Catalog"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$catalog")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("h3",{attrs:{id:"docker-login-with-acr-access-token-single-repository-scope"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-login-with-acr-access-token-single-repository-scope"}},[s._v("#")]),s._v(" Docker login with ACR Access Token - Single repository scope")]),s._v(" "),t("p",[s._v("The following script uses an AAD token to request an 'ACR access token` which can be used as a docker login credential.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#/bin/sh")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REGISTRY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPOSITORY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("AAD_ACCESS_TOKEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("az account get-access-token --query accessToken -o tsv"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ACR_REFRESH_TOKEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -X POST -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t-d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grant_type=access_token&service='),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$REGISTRY")]),s._v("&access_token="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$AAD_ACCESS_TOKEN")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\thttps://$REGISTRY/oauth2/exchange "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.refresh_token'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ACR Refresh Token obtained."')]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Create the repo level scope")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SCOPE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"repository:'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$REPOSITORY")]),s._v(':pull"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# to pull multiple repositories passing in multiple scope arguments. ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#&scope="repository:repo:pull,push')]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\n\nACR_ACCESS_TOKEN='),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -X POST -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t-d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grant_type=refresh_token&service='),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$REGISTRY")]),s._v("&scope="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SCOPE")]),s._v("&refresh_token="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ACR_REFRESH_TOKEN")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\thttps://$REGISTRY/oauth2/token "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.access_token'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('\necho "')]),s._v('ACR Access Token obtained."\n\n'),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Docker Login using the ACR_ACCESS_TOKEN")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" login into "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$REGISTRY")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" login -u 00000000-0000-0000-0000-000000000000 -p "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ACR_ACCESS_TOKEN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$REGISTRY")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" pull "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$REGISTRY")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$REPOSITORY")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")])]),t("h3",{attrs:{id:"fetch-helm-index-yaml-with-admin-keys-or-sp-with-basic-auth"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#fetch-helm-index-yaml-with-admin-keys-or-sp-with-basic-auth"}},[s._v("#")]),s._v(" Fetch helm index.yaml with Admin Keys or SP with Basic Auth")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("registry")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --- you have to fill this out --- "')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("operation")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/helm/v1/repo/index.yaml"')]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("challenge")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -vs https://$registry$operation "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Www-Authenticate:"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Challenge"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$challenge")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("scope")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" $challenge "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'scope=\\"([^\\"]*)\\"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" -o "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\\"([^\\"]*)\\"\'')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Scope"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scope")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("credentials")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$user")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$password")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" base64 -w "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("acr_access_token")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/x-www-form-urlencoded"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Basic '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$credentials")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("/oauth2/token?service="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$registry")]),s._v("&scope="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$scope")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.access_token'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^\"//'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/\"$//'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ACR Access Token"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Retrieve the location header and strip the trailing \\r for curl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("URL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -sD - -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$acr_access_token")]),s._v('"')]),s._v(" https://$registry$operation  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -Fi Location "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tr")]),s._v(" -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\r'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Location")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$URL")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" index.yaml\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" ----------\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$URL")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);