(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{422:function(e,t,a){e.exports=a.p+"assets/img/multi-tenant-app.ba65e72e.png"},423:function(e,t,a){e.exports=a.p+"assets/img/enable-multi-tenant-app.8854a0f9.png"},424:function(e,t,a){e.exports=a.p+"assets/img/aad-app-client-secret.279b5057.png"},425:function(e,t,a){e.exports=a.p+"assets/img/multi-tenant-app-consent.efcc7b5c.png"},426:function(e,t,a){e.exports=a.p+"assets/img/multi-tenant-app-acr-pull.b7237636.png"},487:function(e,t,a){"use strict";a.r(t);var r=a(65),n=Object(r.a)({},(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"set-up-aks-to-pull-from-acr-in-a-different-ad-tenant"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#set-up-aks-to-pull-from-acr-in-a-different-ad-tenant"}},[e._v("#")]),e._v(" Set up AKS to pull from ACR in a different AD tenant")]),e._v(" "),r("h2",{attrs:{id:"introduction"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[e._v("#")]),e._v(" Introduction")]),e._v(" "),r("p",[e._v("There are several ways to set up the auth credential in Kubernetes to pull image from ACR. For example, you can use "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/aks/kubernetes-service-principal",target:"_blank",rel:"noopener noreferrer"}},[e._v("admin user or repository scoped access token"),r("OutboundLink")],1),e._v(" to configure pod "),r("a",{attrs:{href:"https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/",target:"_blank",rel:"noopener noreferrer"}},[e._v("imagePullSecrets"),r("OutboundLink")],1),e._v(".")]),e._v(" "),r("p",[e._v("While "),r("code",[e._v("imagePullSecrets")]),e._v(" is commonly used, it brings the challenge and overhead to manage the corresponding secret. On Azure, you can set up "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/aks/kubernetes-service-principal",target:"_blank",rel:"noopener noreferrer"}},[e._v("AKS cluster with a service principal credential"),r("OutboundLink")],1),e._v(" which allows you securely pull the image from ACR without additional "),r("code",[e._v("imagePullSecrets")]),e._v(" setting on each pod.")]),e._v(" "),r("p",[e._v("Sometimes, you may have your AKS and ACR in different Azure Active Directories (Tenants). This document will walk your through the steps to enable cross tenant authentication using service principal credential.")]),e._v(" "),r("h2",{attrs:{id:"instruction"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#instruction"}},[e._v("#")]),e._v(" Instruction")]),e._v(" "),r("p",[e._v("In this example, the AKS cluster is in "),r("code",[e._v("Tenant A")]),e._v(" and the ACR is in "),r("code",[e._v("Tenant B")]),e._v(".")]),e._v(" "),r("p",[r("code",[e._v("Tenant A")]),e._v(" is also the service principal home tenant.")]),e._v(" "),r("p",[e._v("You will need the contributor role of AKS subscription and the owner role of ACR subscription.")]),e._v(" "),r("h3",{attrs:{id:"step-1-enable-multi-tenant-aad-application"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#step-1-enable-multi-tenant-aad-application"}},[e._v("#")]),e._v(" Step 1: Enable multi-tenant AAD Application")]),e._v(" "),r("ul",[r("li",[r("p",[e._v("Login "),r("a",{attrs:{href:"http://portal.azure.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Azure portal"),r("OutboundLink")],1),e._v(" in "),r("code",[e._v("Tenant A")]),e._v(" and go to Azure Active Directory "),r("code",[e._v("App registrations")]),e._v(" blade to find the service principal application object.")])]),e._v(" "),r("li",[r("p",[e._v("Remember the "),r("code",[e._v("Application (client) ID")]),e._v(" (it will be used in "),r("code",[e._v("step 2")]),e._v(" and "),r("code",[e._v("step 4")]),e._v(")")]),e._v(" "),r("p",[r("img",{attrs:{src:a(422),alt:""}})])]),e._v(" "),r("li",[r("p",[e._v("Choose multitenant account type as the following screenshot and also remember the "),r("code",[e._v("redirect url")]),e._v(" (it will be used in step 2).")]),e._v(" "),r("p",[r("img",{attrs:{src:a(423),alt:""}})])]),e._v(" "),r("li",[r("p",[e._v("Create a client secret if not exist (It is "),r("strong",[e._v("IMPORTANT")]),e._v(" to make sure you use this client secret to update AKS in "),r("code",[e._v("step 4")]),e._v(").")]),e._v(" "),r("p",[r("img",{attrs:{src:a(424),alt:""}})])])]),e._v(" "),r("h3",{attrs:{id:"step-2-provision-the-service-principal-in-acr-tenant"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#step-2-provision-the-service-principal-in-acr-tenant"}},[e._v("#")]),e._v(" Step 2: Provision the service principal in ACR Tenant")]),e._v(" "),r("ul",[r("li",[r("p",[e._v("Open the following link with the Tenant B admin account and accept the permission request.")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("https://login.microsoftonline.com/<ACR Tenant ID (Tenant B)>/oauth2/authorize?client_id=<Application (client) ID>&response_type=code&redirect_uri=<redirect url>\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br")])]),r("p",[r("img",{attrs:{src:a(425),alt:""}})])])]),e._v(" "),r("h3",{attrs:{id:"step-3-grant-service-principal-acr-image-pull-permission"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#step-3-grant-service-principal-acr-image-pull-permission"}},[e._v("#")]),e._v(" Step 3: Grant service principal ACR image pull permission")]),e._v(" "),r("ul",[r("li",[r("p",[e._v("Assign AcrPull role to the service principal")]),e._v(" "),r("p",[r("img",{attrs:{src:a(426),alt:""}})])])]),e._v(" "),r("h3",{attrs:{id:"step-4-update-aks-with-the-aad-application-secret"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#step-4-update-aks-with-the-aad-application-secret"}},[e._v("#")]),e._v(" Step 4: Update AKS with the AAD Application secret")]),e._v(" "),r("ul",[r("li",[e._v("Use the "),r("code",[e._v("Application (client) ID")]),e._v(" and "),r("code",[e._v("client secret")]),e._v(" collected in "),r("code",[e._v("step 1")]),e._v(" to "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/aks/update-credentials#update-aks-cluster-with-new-service-principal-credentials",target:"_blank",rel:"noopener noreferrer"}},[e._v("update AKS service principal credential"),r("OutboundLink")],1),e._v(".")])]),e._v(" "),r("h2",{attrs:{id:"reference"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[e._v("#")]),e._v(" Reference")]),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals",target:"_blank",rel:"noopener noreferrer"}},[e._v("Application and service principal objects in Azure Active Directory"),r("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);