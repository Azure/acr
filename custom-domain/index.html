<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using Custom Domains with Azure Container Registry | Azure Container Registry</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/acr/assets/css/0.styles.1adce09e.css" as="style"><link rel="preload" href="/acr/assets/js/app.3ca3959d.js" as="script"><link rel="preload" href="/acr/assets/js/2.4abe739f.js" as="script"><link rel="preload" href="/acr/assets/js/21.b60fd558.js" as="script"><link rel="prefetch" href="/acr/assets/js/10.080d8072.js"><link rel="prefetch" href="/acr/assets/js/11.a8cae62e.js"><link rel="prefetch" href="/acr/assets/js/12.e62ede07.js"><link rel="prefetch" href="/acr/assets/js/13.88956df0.js"><link rel="prefetch" href="/acr/assets/js/14.da996b77.js"><link rel="prefetch" href="/acr/assets/js/15.128615bf.js"><link rel="prefetch" href="/acr/assets/js/16.28bd344b.js"><link rel="prefetch" href="/acr/assets/js/17.3154ce14.js"><link rel="prefetch" href="/acr/assets/js/18.1a01df13.js"><link rel="prefetch" href="/acr/assets/js/19.d6cd2dad.js"><link rel="prefetch" href="/acr/assets/js/20.3cb003a6.js"><link rel="prefetch" href="/acr/assets/js/22.7d86dba4.js"><link rel="prefetch" href="/acr/assets/js/23.dd656471.js"><link rel="prefetch" href="/acr/assets/js/24.e228cfdd.js"><link rel="prefetch" href="/acr/assets/js/25.197c3531.js"><link rel="prefetch" href="/acr/assets/js/26.29caa7ed.js"><link rel="prefetch" href="/acr/assets/js/27.fb8da073.js"><link rel="prefetch" href="/acr/assets/js/28.6e4543d4.js"><link rel="prefetch" href="/acr/assets/js/29.a76509db.js"><link rel="prefetch" href="/acr/assets/js/3.f910cf4c.js"><link rel="prefetch" href="/acr/assets/js/30.994ccbbb.js"><link rel="prefetch" href="/acr/assets/js/31.f2c11b52.js"><link rel="prefetch" href="/acr/assets/js/32.840e79d8.js"><link rel="prefetch" href="/acr/assets/js/33.2df67567.js"><link rel="prefetch" href="/acr/assets/js/34.e38730f2.js"><link rel="prefetch" href="/acr/assets/js/35.46229160.js"><link rel="prefetch" href="/acr/assets/js/36.9f898214.js"><link rel="prefetch" href="/acr/assets/js/37.9c3a93a2.js"><link rel="prefetch" href="/acr/assets/js/38.2cbce8d9.js"><link rel="prefetch" href="/acr/assets/js/39.f4bfa261.js"><link rel="prefetch" href="/acr/assets/js/4.1d1d93b6.js"><link rel="prefetch" href="/acr/assets/js/40.bc1f46d1.js"><link rel="prefetch" href="/acr/assets/js/41.2dbb6a30.js"><link rel="prefetch" href="/acr/assets/js/42.84fa6a12.js"><link rel="prefetch" href="/acr/assets/js/43.428cb1ec.js"><link rel="prefetch" href="/acr/assets/js/44.3b6b967d.js"><link rel="prefetch" href="/acr/assets/js/45.fd0d1d9e.js"><link rel="prefetch" href="/acr/assets/js/46.19cb06fd.js"><link rel="prefetch" href="/acr/assets/js/47.8c0d7628.js"><link rel="prefetch" href="/acr/assets/js/48.619e29e6.js"><link rel="prefetch" href="/acr/assets/js/49.3ba8bd2c.js"><link rel="prefetch" href="/acr/assets/js/5.943fad70.js"><link rel="prefetch" href="/acr/assets/js/50.0c02f626.js"><link rel="prefetch" href="/acr/assets/js/51.b822281a.js"><link rel="prefetch" href="/acr/assets/js/52.9a8a029d.js"><link rel="prefetch" href="/acr/assets/js/53.57ca9884.js"><link rel="prefetch" href="/acr/assets/js/54.86e09cf3.js"><link rel="prefetch" href="/acr/assets/js/55.21039511.js"><link rel="prefetch" href="/acr/assets/js/56.b6f67eae.js"><link rel="prefetch" href="/acr/assets/js/57.0266cf09.js"><link rel="prefetch" href="/acr/assets/js/58.249e8925.js"><link rel="prefetch" href="/acr/assets/js/59.a2f8607d.js"><link rel="prefetch" href="/acr/assets/js/6.c89b0c48.js"><link rel="prefetch" href="/acr/assets/js/60.f13d2f1c.js"><link rel="prefetch" href="/acr/assets/js/7.cf63200c.js"><link rel="prefetch" href="/acr/assets/js/8.9e525704.js"><link rel="prefetch" href="/acr/assets/js/9.b9ebe781.js">
    <link rel="stylesheet" href="/acr/assets/css/0.styles.1adce09e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/acr/" class="home-link router-link-active"><img src="/acr/files/acr.svg" alt="Azure Container Registry" class="logo"> <span class="site-name can-hide">Azure Container Registry</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/acr/" aria-current="page" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/acr/#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/acr/#blog-posts" class="sidebar-link">Blog posts</a></li><li class="sidebar-sub-header"><a href="/acr/#links" class="sidebar-link">Links</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Teleport</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tasks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Integration</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="using-custom-domains-with-azure-container-registry"><a href="#using-custom-domains-with-azure-container-registry" class="header-anchor">#</a> Using Custom Domains with Azure Container Registry</h1> <p><strong>Important - Using a custom domain in Azure Container Registry is a private preview feature.</strong></p> <p><strong>The Azure Container Registry team is not currently accepting new customers for this private preview. The feature will be made more widely available in the future.</strong></p> <p><strong>If your registry has already been enabled for a custom domain and you need support, please open an issue in this repository.</strong></p> <p>Every ACR is accessed using its login server. If you have a registry called <code>myregistry</code>, you access it using its default hostname, <code>myregistry.azurecr.io</code> (in Azure Public Cloud.) As a customer belonging to an organization, you may prefer to access your registry using a custom domain that is associated with your organization, for instance, <code>container-registry.contoso.com</code>.</p> <p>The following steps describe how you can achieve this.</p> <p><strong>The following sections describe preparation steps for the private preview. THESE STEPS ARE NOT SUFFICIENT TO ENABLE A CUSTOM DOMAIN FOR YOUR REGISTRY WITHOUT ACCEPTANCE INTO THE PRIVATE PREVIEW.</strong></p> <h2 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h2> <ul><li><p><a href="https://docs.microsoft.com/cli/azure/?view=azure-cli-latest" target="_blank" rel="noopener noreferrer">Azure CLI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: version 2.4.0 or higher</p> <ul><li>Consider using <a href="https://docs.microsoft.com/azure/cloud-shell/overview" target="_blank" rel="noopener noreferrer">Azure Cloud Shell<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li> <li><p>A <em>premium</em> Azure Container Registry. See <a href="https://docs.microsoft.com/azure/container-registry/container-registry-get-started-azure-cli" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for instructions on how to create one.</p></li> <li><p>Your custom domain names. The following two are required:</p> <ul><li>Custom registry domain to access the registry REST API. Example for the <code>contoso.com</code> domain: <code>container-registry.contoso.com</code></li> <li>Custom data domain to access the registry content. Again, example for <code>contoso.com</code>: <code>eastus-registry-data.contoso.com</code> <ul><li>Note that the custom data domain is region specific. For geo-replicated registries, each region should have its own custom data endpoint.</li></ul></li></ul> <p>For each domain, you must prepare a single PEM formatted file containing the TLS private key and the public certificate:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-----BEGIN PRIVATE KEY-----  
XXXXXX  
-----END PRIVATE KEY-----  
-----BEGIN CERTIFICATE-----  
XXXXXX  
-----END CERTIFICATE-----
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul> <p>If you use a certificate bundle, prepare a single PEM formatted file containing the TLS private key and each public certificate:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>---BEGIN PRIVATE KEY-----
XXXXXX
-----END PRIVATE KEY-------
-----BEGIN CERTIFICATE-----
XXXXX-01
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
XXXXXX-02
-----END CERTIFICATE----
[etc.]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>For example, using <a href="https://github.com/openssl/openssl" target="_blank" rel="noopener noreferrer">openssl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <ul><li>Create a self-signed public cert and private key<div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openssl req -nodes -x509 -newkey rsa:4096 <span class="token punctuation">\</span>
  -keyout container-registry.contoso.com.key.pem <span class="token punctuation">\</span>
  -out container-registry.contoso.com.cert.pem -days <span class="token number">365</span> <span class="token punctuation">\</span>
  -subj <span class="token string">'/CN=container-registry.contoso.com/O=Contoso./C=US'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li>Create a single file containing both the public certificate (or certificates, in the case of a certificate bundle) and private key<div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> container-registry.contoso.com.key.pem <span class="token punctuation">\</span>
  <span class="token operator">&gt;&gt;</span> container-registry-contoso-com.pem
<span class="token function">cat</span> container-registry.contoso.com.cert.pem <span class="token punctuation">\</span>
  <span class="token operator">&gt;&gt;</span> container-registry-contoso-com.pem
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li>For each data domain, follow the same steps above to prepare the PEM formatted files containing the public certificate and private key.</li></ul> <p>Azure Key Vault allows you to <a href="https://docs.microsoft.com/azure/key-vault/certificate-scenarios" target="_blank" rel="noopener noreferrer">create<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Certificate Authority (CA) signed certificates.</p> <ul><li>If you choose to use the Azure Portal to create the certificates, be sure to select certificate content type as PEM.</li></ul> <h2 id="prepare-your-existing-registry"><a href="#prepare-your-existing-registry" class="header-anchor">#</a> Prepare your existing registry</h2> <p>We will enable two features on your registry:</p> <ul><li><p>Data Endpoints:<br>
This feature provides a dedicated endpoint for downloading content from your registry. If you have a registry in East US, on enabling this feature, a data endpoint is automatically created for you: <code>myregistry.eastus.data.azurecr.io</code></p></li> <li><p>ACR Managed Identities:<br>
Managed Identities provide a mechanism to associate an Azure Active Directory identity with your registry, while relieving you of the burden of managing credentials. To learn more, see the documentation <a href="https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.<br>
ACR supports both user assigned and system assigned managed identities.</p></li></ul> <h3 id="enable-data-endpoints-and-managed-idenitites"><a href="#enable-data-endpoints-and-managed-idenitites" class="header-anchor">#</a> Enable data endpoints and managed idenitites</h3> <ol><li><code>az login</code></li> <li><code>az account set -s &lt;subscription-id-or-name&gt;</code></li> <li><code>az acr update --data-endpoint-enabled true -n myregistry</code></li> <li>You can either enable a system assigned managed identity, a user assigned managed identity, or both for your registry. We recommend using system assigned managed identity to enable advanced scenarios with virtual networks that, although not supported currently, are <a href="#enhanced-security-with-virtual-networks">coming soon</a>. Do <em>one</em> of the following:
<ul><li>To enable only system assigned managed identity:
<ul><li><code>az acr identity assign -n myregistry --identities [system]</code></li></ul></li> <li>To enable user assigned managed identity, with or without a system identity:
<ul><li>Create a user assigned managed identity following the instructions <a href="https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Do <em>one</em> of the following:
<ul><li>To enable <em>only</em> user assigned managed identity:
<ul><li><code>az acr identity assign -n myregistry --identities &quot;&lt;arm-resource-id-of-user-assigned-identity&gt;&quot;</code></li></ul></li> <li>To enable <em>both</em> user and system assigned managed identities:
<ul><li><code>az acr identity assign -n myregistry --identities &quot;&lt;arm-resource-id-of-user-assigned-identity&gt;&quot; [system]</code></li></ul></li></ul></li></ul></li></ul></li></ol> <h2 id="prepare-your-azure-key-vault"><a href="#prepare-your-azure-key-vault" class="header-anchor">#</a> Prepare your Azure Key Vault</h2> <p>For each domain, its TLS private key and public certificate pair must be added to an Azure Key Vault that is accessible by your registry as a single PEM formatted file. We recommend creating a new key vault containing only your TLS certificates and granting the registry's identity access to <code>get</code> secret.</p> <ol><li><a href="https://docs.microsoft.com/azure/key-vault/" target="_blank" rel="noopener noreferrer">Create<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> a new Azure Key Vault.</li> <li><a href="https://docs.microsoft.com/azure/key-vault/certificate-scenarios" target="_blank" rel="noopener noreferrer">Add<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> your certificates to the key vault.</li> <li>Add an access policy to the key vault that grants your registry's identity access to <code>get</code> secret:<br> <code>az keyvault set-policy --name &lt;your-kv-name&gt; --secret-permissions get --spn &lt;registry-system-or-user-mi-principal-id&gt;</code> <ul><li>The output of the command to enable managed identities on the registry will contain the principal ids of the assiged identities.</li> <li>Alternatively, you may obtain the principal ids using <code>az cli</code>:
<ul><li>For system assigned managed identity:
<ul><li><code>az acr show -n myregistry --query identity.principalId -o tsv</code></li></ul></li> <li>For user assigned managed identities, you may list them as follows and use the desired principal ID:
<ul><li><code>az acr show -n myregistry --query identity.userAssignedIdentities</code></li></ul></li></ul></li></ul></li></ol> <p>For greater isolation, we recommend that you put each certificate in its own key vault and set its access policy independently. The registry should always have access to the key vault secrets.</p> <h3 id="certificate-updates-and-rotation"><a href="#certificate-updates-and-rotation" class="header-anchor">#</a> Certificate updates and rotation</h3> <p>You have two options for updating the certificates used for custom domains:</p> <ul><li><p><strong>Automatic updates</strong> - If you reference a custom domain certificate with a <a href="https://docs.microsoft.com/azure/key-vault/general/about-keys-secrets-certificates#objects-identifiers-and-versioning" target="_blank" rel="noopener noreferrer">non-versioned<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> secret ID, the registry regularly checks the key vault and automatically uses the latest certificate version there for its operations.</p> <p>To rotate or update a custom domain certificate, upload the new certificate version to the secret's location in the key vault. The registry automatically uses the latest certificate version within a short time.</p> <blockquote><p>NOTE: after the certificate is updated, the registry may serve a mix of the old and new certificate versions for upto 15 minutes until all caches have been refreshed.</p></blockquote></li> <li><p><strong>Manual updates</strong> - If you reference a domain certificate with a <a href="https://docs.microsoft.com/azure/key-vault/general/about-keys-secrets-certificates#objects-identifiers-and-versioning" target="_blank" rel="noopener noreferrer">versioned<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> secret ID, the registry does not configure automatic certificate rotation.</p> <p>After you upload a new certificate version to the key vault, the certificate must be manually rotated in the registry. Contact <a href="https://azure.microsoft.com/support/create-ticket/" target="_blank" rel="noopener noreferrer">Azure Support<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></li></ul> <h3 id="enhanced-security-with-virtual-networks"><a href="#enhanced-security-with-virtual-networks" class="header-anchor">#</a> Enhanced security with Virtual Networks</h3> <p>Azure Key Vault allows you to <a href="https://docs.microsoft.com/azure/key-vault/key-vault-overview-vnet-service-endpoints" target="_blank" rel="noopener noreferrer">restrict access<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to specific virtual networks only. ACR custom domains are currently <em>not supported</em> where key vault access is restricted, but this is work in progress and will be available with system managed identities only.</p> <h2 id="prepare-your-dns-zone"><a href="#prepare-your-dns-zone" class="header-anchor">#</a> Prepare your DNS zone</h2> <ol><li>The custom registry domain must have a CNAME record with the target registry login server:<br> <code>container-registry.contoso.com</code> --&gt; <code>myregistry.azurecr.io</code></li> <li>The regional custom data domain must have a CNAME record with the target regional registry data endpoint:<br> <code>eastus-registry-data.contoso.com</code> --&gt; <code>myregistry.eastus.data.azurecr.io</code> <ul><li>The output of the command to enable data endpoints on the registry will contain the regional data endpoint.</li></ul></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azure/acr/edit/master/docs/custom-domain/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/acr/assets/js/app.3ca3959d.js" defer></script><script src="/acr/assets/js/2.4abe739f.js" defer></script><script src="/acr/assets/js/21.b60fd558.js" defer></script>
  </body>
</html>
