<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How to manage public content in private registry | Azure Container Registry</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="....">
    
    <link rel="preload" href="/acr/assets/css/0.styles.1adce09e.css" as="style"><link rel="preload" href="/acr/assets/js/app.3ca3959d.js" as="script"><link rel="preload" href="/acr/assets/js/2.4abe739f.js" as="script"><link rel="preload" href="/acr/assets/js/8.9e525704.js" as="script"><link rel="prefetch" href="/acr/assets/js/10.080d8072.js"><link rel="prefetch" href="/acr/assets/js/11.a8cae62e.js"><link rel="prefetch" href="/acr/assets/js/12.e62ede07.js"><link rel="prefetch" href="/acr/assets/js/13.88956df0.js"><link rel="prefetch" href="/acr/assets/js/14.da996b77.js"><link rel="prefetch" href="/acr/assets/js/15.128615bf.js"><link rel="prefetch" href="/acr/assets/js/16.28bd344b.js"><link rel="prefetch" href="/acr/assets/js/17.3154ce14.js"><link rel="prefetch" href="/acr/assets/js/18.1a01df13.js"><link rel="prefetch" href="/acr/assets/js/19.d6cd2dad.js"><link rel="prefetch" href="/acr/assets/js/20.3cb003a6.js"><link rel="prefetch" href="/acr/assets/js/21.b60fd558.js"><link rel="prefetch" href="/acr/assets/js/22.7d86dba4.js"><link rel="prefetch" href="/acr/assets/js/23.dd656471.js"><link rel="prefetch" href="/acr/assets/js/24.e228cfdd.js"><link rel="prefetch" href="/acr/assets/js/25.197c3531.js"><link rel="prefetch" href="/acr/assets/js/26.29caa7ed.js"><link rel="prefetch" href="/acr/assets/js/27.fb8da073.js"><link rel="prefetch" href="/acr/assets/js/28.6e4543d4.js"><link rel="prefetch" href="/acr/assets/js/29.a76509db.js"><link rel="prefetch" href="/acr/assets/js/3.f910cf4c.js"><link rel="prefetch" href="/acr/assets/js/30.994ccbbb.js"><link rel="prefetch" href="/acr/assets/js/31.f2c11b52.js"><link rel="prefetch" href="/acr/assets/js/32.840e79d8.js"><link rel="prefetch" href="/acr/assets/js/33.2df67567.js"><link rel="prefetch" href="/acr/assets/js/34.e38730f2.js"><link rel="prefetch" href="/acr/assets/js/35.46229160.js"><link rel="prefetch" href="/acr/assets/js/36.9f898214.js"><link rel="prefetch" href="/acr/assets/js/37.9c3a93a2.js"><link rel="prefetch" href="/acr/assets/js/38.2cbce8d9.js"><link rel="prefetch" href="/acr/assets/js/39.f4bfa261.js"><link rel="prefetch" href="/acr/assets/js/4.1d1d93b6.js"><link rel="prefetch" href="/acr/assets/js/40.bc1f46d1.js"><link rel="prefetch" href="/acr/assets/js/41.2dbb6a30.js"><link rel="prefetch" href="/acr/assets/js/42.84fa6a12.js"><link rel="prefetch" href="/acr/assets/js/43.428cb1ec.js"><link rel="prefetch" href="/acr/assets/js/44.3b6b967d.js"><link rel="prefetch" href="/acr/assets/js/45.fd0d1d9e.js"><link rel="prefetch" href="/acr/assets/js/46.19cb06fd.js"><link rel="prefetch" href="/acr/assets/js/47.8c0d7628.js"><link rel="prefetch" href="/acr/assets/js/48.619e29e6.js"><link rel="prefetch" href="/acr/assets/js/49.3ba8bd2c.js"><link rel="prefetch" href="/acr/assets/js/5.943fad70.js"><link rel="prefetch" href="/acr/assets/js/50.0c02f626.js"><link rel="prefetch" href="/acr/assets/js/51.b822281a.js"><link rel="prefetch" href="/acr/assets/js/52.9a8a029d.js"><link rel="prefetch" href="/acr/assets/js/53.57ca9884.js"><link rel="prefetch" href="/acr/assets/js/54.86e09cf3.js"><link rel="prefetch" href="/acr/assets/js/55.21039511.js"><link rel="prefetch" href="/acr/assets/js/56.b6f67eae.js"><link rel="prefetch" href="/acr/assets/js/57.0266cf09.js"><link rel="prefetch" href="/acr/assets/js/58.249e8925.js"><link rel="prefetch" href="/acr/assets/js/59.a2f8607d.js"><link rel="prefetch" href="/acr/assets/js/6.c89b0c48.js"><link rel="prefetch" href="/acr/assets/js/60.f13d2f1c.js"><link rel="prefetch" href="/acr/assets/js/7.cf63200c.js"><link rel="prefetch" href="/acr/assets/js/9.b9ebe781.js">
    <link rel="stylesheet" href="/acr/assets/css/0.styles.1adce09e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/acr/" class="home-link router-link-active"><img src="/acr/files/acr.svg" alt="Azure Container Registry" class="logo"> <span class="site-name can-hide">Azure Container Registry</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/acr/" aria-current="page" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/acr/#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/acr/#blog-posts" class="sidebar-link">Blog posts</a></li><li class="sidebar-sub-header"><a href="/acr/#links" class="sidebar-link">Links</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Teleport</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tasks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Integration</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="how-to-consume-maintain-public-content-with-azure-container-registry-tasks"><a href="#how-to-consume-maintain-public-content-with-azure-container-registry-tasks" class="header-anchor">#</a> How to consume &amp; maintain public content with Azure Container Registry Tasks</h1> <p>An Azure container registry hosts your container images and other <a href="https://aka.ms/acr/artifacts" target="_blank" rel="noopener noreferrer">OCI artifacts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in a private, authenticated environment. However, your environment may have dependencies on public content such as public container images, <a href="https://helm.sh" target="_blank" rel="noopener noreferrer">helm charts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://www.openpolicyagent.org/" target="_blank" rel="noopener noreferrer">Open Policy Agent (OPA)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> policies or other artifacts. For example, you might run [nginx] for service routing or <code>docker build FROM</code> <a href="https://hub.docker.com/_/alpine" target="_blank" rel="noopener noreferrer">alpine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by pulling images directly from Docker Hub or another public registry. As upstream changes occur, this article will explain how to import and maintain these public artifacts.</p> <p>For more information about the risks introduced by dependencies on public content and best practices see the <a href="https://docs.google.com/document/d/1fxayMznIkszBI9Y2S3KGSyi2hFMwUIwDfn3D2wQcye4/edit?usp=sharing" target="_blank" rel="noopener noreferrer">OCI Consuming Public Content Blog post<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>This article covers features and workflows in Azure Container Registry to help you manage consuming and maintaining public content:</p> <ul><li>Import local copies of dependent public images.</li> <li>Validate public images through security scanning and functional testing.</li> <li>Promoting to private registries for internal usage.</li> <li>Triggering base image updates for applications dependent upon public content.</li> <li>Using <a href="/acr/container-registry-tasks-overview.html">ACR Tasks</a> to automate this workflow.</li></ul> <p><img src="/acr/assets/img/consuming-public-content-workflow.852071b4.png" alt="Consuming Public Content Workflow"></p> <p>This article refers mainly to container images, but the concepts apply to other supported <a href="/acr/container-registry-image-formats.html">registry artifacts</a>.</p> <p>The gated import workflow refers to decoupling your organizations dependencies on externally managed artifacts. For instance, images sourced from public registries like: <a href="https://hub.docker.com" target="_blank" rel="noopener noreferrer">docker hub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://cloud.google.com/container-registry" target="_blank" rel="noopener noreferrer">gcr<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://quay.io" target="_blank" rel="noopener noreferrer">quay<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://docs.github.com/en/free-pro-team@latest/packages/getting-started-with-github-container-registry/about-github-container-registry" target="_blank" rel="noopener noreferrer">github container registry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://aka.ms/mcr" target="_blank" rel="noopener noreferrer">Microsoft Container Registry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or even other public <a href="https://aka.ms/acr" target="_blank" rel="noopener noreferrer">Azure Container Registries<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Consider balancing these two, possibly conflicting goals:</p> <ol><li>Do you really want an unexpected upstream change to possibly take out your production system?</li> <li>Do you want upstream security fixes, for the versions you depend upon, to be automatically deployed?</li></ol> <h2 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h2> <ul><li>Create three registries to represent the workflow
<ul><li>A simulated copy of docker hub for public images.
<ul><li>This allows us simulate a base image update, which would normally be initiated on <a href="https://hub.docker.com" target="_blank" rel="noopener noreferrer">Docker Hub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or other public registries.</li></ul></li> <li>A development team registry, that will host one more more teams that build and manage images.
<ul><li><strong>Note:</strong> <a href="https://aka.ms/acr/repo-permissions" target="_blank" rel="noopener noreferrer">repository based RBAC (preview)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is now available, enabling multiple teams to share a single registry, with unique permission sets</li></ul></li> <li>A registry to host imported base artifacts.</li></ul></li> <li>An Azure KeyVault for storing access keys to the registries</li> <li>An <a href="https://aka.ms/aci" target="_blank" rel="noopener noreferrer">Azure Container Instance<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to host the <code>hello-world</code> image.</li></ul> <p>The following steps will:</p> <ol><li>Configure unique values for your environment</li> <li>Simulate a Public Registry</li> <li>Automate building a hello-world image</li> <li>Automate deploying to an <a href="https://aka.ms/aci" target="_blank" rel="noopener noreferrer">Azure Container Instance<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Simulate upstream changes directly to your environment</li> <li>Create a gated import, that validates upstream changes are appropriate for your environment</li></ol> <p><img src="/acr/assets/img/consuming-public-content-objects.3679c56f.png" alt="import workflow components"></p> <p>This walk through will:</p> <ol><li>Configure three registries representing:
<ul><li>Simulated Docker Hub (<code>publicregistry</code>)to support changing the base image</li> <li>Team registry (<code>contoso</code>) for private images</li> <li>Company/team shared registry (<code>baseartifacts</code>) for imported public content</li></ul></li> <li>Configure ACR Tasks to:
<ul><li>build the simulated public node image</li> <li>import and validate the public node image to the company/team shared registry</li> <li>build and deploy the hello-world image</li></ul></li> <li>ACR Task definitions, including configurations for:</li> <li>Collection of registry credentials which can be pointers to KeyVault</li> <li>Collection of secrets, available within an <code>acr-task.yaml</code>, which are pointers to KeyVault</li> <li>Collection of configured values used within an <code>acr-task.yaml</code>.</li> <li>An Azure KeyVault, securing all secrets</li> <li>An Azure Container Instance, hosting the hello-world build application</li></ol> <h3 id="set-environment-variables"><a href="#set-environment-variables" class="header-anchor">#</a> Set environment variables</h3> <p>Configure variables unique to your environment. We follow best practices for placing resources with durable content in their own resource group to minimize accidental deletion, however you can place these in a single resource group if desired.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code># Set the three registry names, unique to your environment:
REGISTRY_PUBLIC=publicregistry
REGISTRY_BASE_ARTIFACTS=contosobaseartifacts
REGISTRY=contoso

# set the location all resources will be created in:
RESOURCE_GROUP_LOCATION=eastus

# default resource groups
REGISTRY_PUBLIC_RG=${REGISTRY_PUBLIC}-rg
REGISTRY_BASE_ARTIFACTS_RG=${REGISTRY_BASE_ARTIFACTS}-rg
REGISTRY_RG=${REGISTRY}-rg

# fully qualified registry urls
REGISTRY_DOCKERHUB_URL=docker.io
REGISTRY_PUBLIC_URL=${REGISTRY_PUBLIC}.azurecr.io
REGISTRY_BASE_ARTIFACTS_URL=${REGISTRY_BASE_ARTIFACTS}.azurecr.io
REGISTRY_URL=${REGISTRY}.azurecr.io

# Azure KeyVault for storing secrets
AKV=acr-task-credentials
AKV_RG=${AKV}-rg

# ACI for hosting the deployed application
ACI=hello-world-aci
ACI_RG=${ACI}-rg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="git-repositories-and-tokens"><a href="#git-repositories-and-tokens" class="header-anchor">#</a> GIT repositories and tokens</h3> <p>To simulate your environment, fork each of these into repositories you can mange. Then, update the variables for your forked repositories.
Notice <code>:main</code> concatenated to the end of the git URLs representing the default repository branch.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>GIT_BASE_IMAGE_NODE=https://github.com/importing-public-content/base-image-node.git#main
GIT_NODE_IMPORT=https://github.com/importing-public-content/import-baseimage-node.git#main
GIT_HELLO_WORLD=https://github.com/importing-public-content/hello-world.git#main
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Establish a <a href="https://github.com/settings/tokens" target="_blank" rel="noopener noreferrer">Git Token<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for ACR Tasks to clone and establish git webhooks.
See: @DAN, CAN YOU UPDATE TO A REFERENCE FOR REQUIRED PERMISSIONS?</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>GIT_TOKEN=&lt;set-git-token-here&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Docker Hub Credentials<br>
To avoid throttling and identify requests, <a href="https://hub.docker.com/settings/security" target="_blank" rel="noopener noreferrer">create a Docker Hub token<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>REGISTRY_DOCKERHUB_USER=&lt;yourusername&gt;
REGISTRY_DOCKERHUB_PASSWORD=&lt;yourtoken&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="create-resources"><a href="#create-resources" class="header-anchor">#</a> Create Resources</h3> <p>Create the three registries:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az group create --name $REGISTRY_PUBLIC_RG --location $RESOURCE_GROUP_LOCATION
az acr create --resource-group $REGISTRY_PUBLIC_RG --name $REGISTRY_PUBLIC --sku Premium

az group create --name $REGISTRY_BASE_ARTIFACTS_RG --location $RESOURCE_GROUP_LOCATION
az acr create --resource-group $REGISTRY_BASE_ARTIFACTS_RG --name $REGISTRY_BASE_ARTIFACTS --sku Premium

az group create --name $REGISTRY_RG --location $RESOURCE_GROUP_LOCATION
az acr create --resource-group $REGISTRY_RG --name $REGISTRY --sku Premium
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Create a KeyVault for secrets</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az group create --name $AKV_RG --location $RESOURCE_GROUP_LOCATION
az keyvault create --resource-group $AKV_RG --name $AKV
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Create a Docker Hub token<br>
To avoid throttling and identify requests, <a href="https://hub.docker.com/settings/security" target="_blank" rel="noopener noreferrer">create a Docker Hub token<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az keyvault secret set \
--vault-name $AKV \
--name registry-dockerhub-user \
--value $REGISTRY_DOCKERHUB_USER

az keyvault secret set \
--vault-name $AKV \
--name registry-dockerhub-password \
--value $REGISTRY_DOCKERHUB_PASSWORD
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Set and Verify a Git token within KeyVault</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az keyvault secret set --vault-name $AKV --name github-token --value $GIT_TOKEN
az keyvault secret show --vault-name $AKV --name github-token --query value -o tsv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Create a Resource Group for an Azure Container Instance</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az group create --name $ACI_RG --location $RESOURCE_GROUP_LOCATION
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="create-public-node-base-image"><a href="#create-public-node-base-image" class="header-anchor">#</a> Create public node base image</h3> <p>To simulate the node image on Docker Hub, create an <a href="https://aka.ms/acr/tasks" target="_blank" rel="noopener noreferrer">ACR Task<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to build and maintain the public image. This allows simulating changes by the node image maintainers.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task create \
  --name node-public \
  -r $REGISTRY_PUBLIC \
  -f acr-task.yaml \
  --context $GIT_BASE_IMAGE_NODE \
  --git-access-token $(az keyvault secret show \
                        --vault-name $AKV \
                        --name github-token \
                        --query value -o tsv) \
  --set REGISTRY_FROM_URL=${REGISTRY_DOCKERHUB_URL}/ \
  --assign-identity
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>To avoid Docker throttling, add <a href="https://hub.docker.com/settings/security" target="_blank" rel="noopener noreferrer">Docker Hub credentials<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task credential add \
  -n node-public \
  -r $REGISTRY_PUBLIC \
  --login-server $REGISTRY_DOCKERHUB_URL \
  -u https://${AKV}.vault.azure.net/secrets/registry-dockerhub-user \
  -p https://${AKV}.vault.azure.net/secrets/registry-dockerhub-password \
  --use-identity [system]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Grant access to ACR for reading values from KeyVault</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az keyvault set-policy \
  --name $AKV \
  --resource-group $AKV_RG \
  --object-id $(az acr task show \
                  --name node-public \
                  --registry $REGISTRY_PUBLIC \
                  --query identity.principalId --output tsv) \
  --secret-permissions get
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-tasks-overview#task-scenarios" target="_blank" rel="noopener noreferrer">Tasks can be triggered<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by git commits, base image updates, scheduled runs or manually executed.
Run the task to generate the <code>node</code> image</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task run -r $REGISTRY_PUBLIC -n node-public
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>List the image in the simulated public registry</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr repository show-tags -n $REGISTRY_PUBLIC --repository node
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="create-the-hello-world-image"><a href="#create-the-hello-world-image" class="header-anchor">#</a> Create the hello-world image</h2> <p>Based on the simulated public node image, build a hello-world image.</p> <h3 id="create-a-token-for-access-to-the-public-registry"><a href="#create-a-token-for-access-to-the-public-registry" class="header-anchor">#</a> Create a Token for access to the &quot;public&quot; registry</h3> <p>Using <a href="https://aka.ms/acr/tokens" target="_blank" rel="noopener noreferrer">ACR Tokens<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, create access tokens, scoped to <code>pull</code></p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az keyvault secret set \
  --vault-name $AKV \
  --name &quot;registry-${REGISTRY_PUBLIC}-user&quot; \
  --value &quot;registry-${REGISTRY_PUBLIC}-user&quot;

az keyvault secret set \
  --vault-name $AKV \
  --name &quot;registry-${REGISTRY_PUBLIC}-password&quot; \
  --value $(az acr token create \
              --name &quot;registry-${REGISTRY_PUBLIC}-user&quot; \
              --registry $REGISTRY_PUBLIC \
              --scope-map _repositories_pull \
              -o tsv \
              --query credentials.passwords[0].value)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="create-an-acr-token-for-access-by-aci-to-pull-the-image"><a href="#create-an-acr-token-for-access-by-aci-to-pull-the-image" class="header-anchor">#</a> Create an ACR Token for access by ACI to pull the image</h3> <p>A token to the registry with <code>hello-world</code> is created. Permissions are scoped to read (pull)</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az keyvault secret set \
  --vault-name $AKV \
  --name &quot;registry-${REGISTRY}-user&quot; \
  --value &quot;registry-${REGISTRY}-user&quot;

az keyvault secret set \
  --vault-name $AKV \
  --name &quot;registry-${REGISTRY}-password&quot; \
  --value $(az acr token create \
              --name &quot;registry-${REGISTRY}-user&quot; \
              --registry $REGISTRY \
              --repository hello-world content/read \
              -o tsv \
              --query credentials.passwords[0].value)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="create-and-maintain-a-hello-world-image-using-acr-tasks"><a href="#create-and-maintain-a-hello-world-image-using-acr-tasks" class="header-anchor">#</a> Create and maintain a <code>hello-world</code> image using ACR Tasks</h3> <p>Simulating a public registry, which could be docker hub, provide credentials using <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-tasks-authentication-managed-identity#4-optional-add-credentials-to-the-task" target="_blank" rel="noopener noreferrer">acr task credentials<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Since the registry is an ACR, use the token created above. The <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-tasks-authentication-managed-identity#4-optional-add-credentials-to-the-task" target="_blank" rel="noopener noreferrer">acr task credentials<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> may be used to pass docker credentials to any registry, including Docker Hub.</p> <p>Within the <code>acr-task.yaml</code>, we deploy the newly built image to ACI. The resource group was created above. By calling <code>az container create</code> with only a difference in the <code>image:tag</code>, the same instance is used.</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task create \
  -n hello-world \
  -r $REGISTRY \
  -f acr-task.yaml \
  --context $GIT_HELLO_WORLD \
  --git-access-token $(az keyvault secret show \
                        --vault-name $AKV \
                        --name github-token \
                        --query value -o tsv) \
  --set REGISTRY_FROM_URL=${REGISTRY_PUBLIC_URL}/ \
  --set KEYVAULT=$AKV \
  --set ACI=$ACI \
  --set ACI_RG=$ACI_RG \
  --assign-identity
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>Add credentials for our Public Registry</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task credential add \
  -n hello-world \
  -r $REGISTRY \
  --login-server $REGISTRY_PUBLIC_URL \
  -u https://${AKV}.vault.azure.net/secrets/registry-${REGISTRY_PUBLIC}-user \
  -p https://${AKV}.vault.azure.net/secrets/registry-${REGISTRY_PUBLIC}-password \
  --use-identity [system]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Grant access to read values from the KeyVault</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az keyvault set-policy \
  --name $AKV \
  --resource-group $AKV_RG \
  --object-id $(az acr task show \
                  --name hello-world \
                  --registry $REGISTRY \
                  --query identity.principalId --output tsv) \
  --secret-permissions get
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Grant the task access to create and manage ACI by granting access to the resource group:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az role assignment create \
  --assignee $(az acr task show \
  --name hello-world \
  --registry $REGISTRY \
  --query identity.principalId --output tsv) \
  --scope $(az group show -n $ACI_RG --query id -o tsv) \
  --role owner
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>With the task created, run the task to build/deploy the hello-world image:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task run -r $REGISTRY -n hello-world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once created, browse the site hosting the <code>hell-world</code> image.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>explorer.exe <span class="token string">&quot;http://&quot;</span><span class="token variable"><span class="token variable">$(</span>az container show <span class="token punctuation">\</span>
  --resource-group $ACI_RG <span class="token punctuation">\</span>
  --name $<span class="token punctuation">{</span>ACI<span class="token punctuation">}</span> <span class="token punctuation">\</span>
  --query ipAddress.ip <span class="token punctuation">\</span>
  --out tsv<span class="token variable">)</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="update-the-base-image-with-a-bad-change"><a href="#update-the-base-image-with-a-bad-change" class="header-anchor">#</a> Update the base image with a &quot;bad&quot; change</h2> <p>Open the <code>Dockerfile</code> in base-image-node repo
Change the <code>BACKGROUND_COLOR</code> to <code>Red</code> to simulate a change that would break our environment.</p> <div class="language-Dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">ARG</span> REGISTRY_NAME=</span>
<span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${REGISTRY_NAME}</span>node:15-alpine</span>
<span class="token instruction"><span class="token keyword">ENV</span> NODE_VERSION 15-alpine</span>
<span class="token instruction"><span class="token keyword">ENV</span> BACKGROUND_COLOR Red</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Commit the change and watch for ACR Tasks to automatically start building.</p> <p>Watch for the task to start executing:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>watch -n1 az acr task list-runs -r $REGISTRY_PUBLIC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>You should eventually see STATUS <code>Succeeded</code> based on a TRIGGER of <code>Commit</code>:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>RUN ID    TASK      PLATFORM    STATUS     TRIGGER    STARTED               DURATION
--------  --------  ----------  ---------  ---------  --------------------  ----------
ca4       hub-node  linux       Succeeded  Commit     2020-10-24T05:02:29Z  00:00:22
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Type <code>CTRL-C</code> to exit the watch command, then view the logs for the most recent run:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task logs -r $REGISTRY_PUBLIC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once the node image is completed, <code>watch</code> for ACR Tasks to automatically start the hello-world image:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>watch -n1 az acr task list-runs -r $REGISTRY
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>You should eventually see STATUS <code>Succeeded</code> based on a TRIGGER of <code>Image Update</code></p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>RUN ID    TASK         PLATFORM    STATUS     TRIGGER       STARTED               DURATION
--------  -----------  ----------  ---------  ------------  --------------------  ----------
dau       hello-world  linux       Succeeded  Image Update  2020-10-24T05:08:45Z  00:00:31
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Type <code>CTRL-C</code> to exit the watch command, then view the logs for the most recent run:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task logs -r $REGISTRY
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once completed, browse the site hosting the updated <code>hell-world</code> image, which should have a red (broken) background.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>explorer.exe <span class="token string">&quot;http://&quot;</span><span class="token variable"><span class="token variable">$(</span>az container show <span class="token punctuation">\</span>
  --resource-group $ACI_RG <span class="token punctuation">\</span>
  --name $<span class="token punctuation">{</span>ACI<span class="token punctuation">}</span> <span class="token punctuation">\</span>
  --query ipAddress.ip <span class="token punctuation">\</span>
  --out tsv<span class="token variable">)</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="checking-in"><a href="#checking-in" class="header-anchor">#</a> Checking in</h2> <p>At this point, you've created a <code>hello-world</code> image that is automatically built on git commits, and changes to the base <code>node</code> image. While we've built against a base image in ACR, this could be any supported registry.</p> <p>The ACR Task base image update trigger automatically re-executes as the node image is updated. As seen here, not all updates are wanted.</p> <h2 id="gated-imports-of-public-content"><a href="#gated-imports-of-public-content" class="header-anchor">#</a> Gated imports of public content</h2> <p>To prevent upstream changes from breaking critical workloads, security scanning and functional tests may be addedd.</p> <p>This section covers:</p> <ul><li>Build a test image</li> <li>Run a functional test script <code>./test.sh</code> against the test image</li> <li>If the image tests successfully, import the public image to the <strong>baseimages</strong> registry</li></ul> <h3 id="write-automation-testing"><a href="#write-automation-testing" class="header-anchor">#</a> Write automation testing</h3> <p>To gate any upstream content, automated testing is implemented. In this example, a <code>test.sh</code> is provided which checks the <code>$BACKGROUND_COLOR</code>. If the test fails, an <code>EXIT_CODE</code> of <code>1</code> is returned which causes the ACR Task step to fail, ending the task run. The tests can be expanded in any form of tools, including logging results. The gate is managed by a pass/fail response.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;&quot;</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $BACKGROUND_COLOR <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'[:lower:]'</span> <span class="token string">'[:upper:]'</span><span class="token variable">)</span></span> <span class="token operator">=</span> <span class="token string">'RED'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> -e <span class="token string">&quot;<span class="token entity" title="\e">\e</span>[31mERROR: Invalid Color:<span class="token entity" title="\e">\e</span>[0m&quot;</span> <span class="token variable">${BACKGROUND_COLOR}</span>
    <span class="token assign-left variable">EXIT_CODE</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">else</span>
  <span class="token builtin class-name">echo</span> -e <span class="token string">&quot;<span class="token entity" title="\e">\e</span>[32mValidation Complete - No Known Errors<span class="token entity" title="\e">\e</span>[0m&quot;</span>
<span class="token keyword">fi</span>
<span class="token builtin class-name">exit</span> <span class="token variable">${EXIT_CODE}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>The <code>acr-task.yaml</code> performs the following steps:</p> <ul><li>Build the test base image using the following dockerfile:<div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">ARG</span> REGISTRY_FROM_URL=</span>
<span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${REGISTRY_FROM_URL}</span>node:15-alpine</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /test</span>
<span class="token instruction"><span class="token keyword">COPY</span> ./test.sh .</span>
<span class="token instruction"><span class="token keyword">CMD</span> ./test.sh</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li>When completed, validate the image by running the container, which runs <code>./test.sh</code></li> <li>Only if successfully completed, run the import steps, which are gated with <code>when: ['validate-base-image']</code></li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> v1.1.0
<span class="token key atrule">steps</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> build<span class="token punctuation">-</span>test<span class="token punctuation">-</span>base<span class="token punctuation">-</span>image
    <span class="token comment"># Build off the base image we'll track</span>
    <span class="token comment"># Add a test script to do unit test validations</span>
    <span class="token comment"># Note: the test validation image isn't saved to the registry</span>
    <span class="token comment"># but the task logs captures log validation results</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> <span class="token punctuation">&gt;</span><span class="token scalar string">
      --build-arg REGISTRY_FROM_URL={{.Values.REGISTRY_FROM_URL}}
      -f ./Dockerfile
      -t {{.Run.Registry}}/node-import:test
      .</span>
  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> validate<span class="token punctuation">-</span>base<span class="token punctuation">-</span>image
    <span class="token comment"># only continues if node-import:test returns a non-zero code</span>
    <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'build-test-base-image'</span><span class="token punctuation">]</span>
    <span class="token key atrule">cmd</span><span class="token punctuation">:</span> <span class="token string">&quot;{{.Run.Registry}}/node-import:test&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> pull<span class="token punctuation">-</span>base<span class="token punctuation">-</span>image
    <span class="token comment"># import the public image to base-artifacts</span>
    <span class="token comment"># Override the stable tag,</span>
    <span class="token comment"># and create a unique tag to enable rollback</span>
    <span class="token comment"># to a previously working image</span>
    <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'validate-base-image'</span><span class="token punctuation">]</span>
    <span class="token key atrule">cmd</span><span class="token punctuation">:</span> <span class="token punctuation">&gt;</span><span class="token scalar string">
        docker pull {{.Values.REGISTRY_FROM_URL}}node:15-alpine</span>
  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> retag<span class="token punctuation">-</span>base<span class="token punctuation">-</span>image
    <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'pull-base-image'</span><span class="token punctuation">]</span>
    <span class="token key atrule">cmd</span><span class="token punctuation">:</span> docker tag <span class="token punctuation">{</span><span class="token punctuation">{</span>.Values.REGISTRY_FROM_URL<span class="token punctuation">}</span><span class="token punctuation">}</span>node<span class="token punctuation">:</span>15<span class="token punctuation">-</span>alpine <span class="token punctuation">{</span><span class="token punctuation">{</span>.Run.Registry<span class="token punctuation">}</span><span class="token punctuation">}</span>/node<span class="token punctuation">:</span>15<span class="token punctuation">-</span>alpine
  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> retag<span class="token punctuation">-</span>base<span class="token punctuation">-</span>image<span class="token punctuation">-</span>unique<span class="token punctuation">-</span>tag
    <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'pull-base-image'</span><span class="token punctuation">]</span>
    <span class="token key atrule">cmd</span><span class="token punctuation">:</span> docker tag <span class="token punctuation">{</span><span class="token punctuation">{</span>.Values.REGISTRY_FROM_URL<span class="token punctuation">}</span><span class="token punctuation">}</span>node<span class="token punctuation">:</span>15<span class="token punctuation">-</span>alpine <span class="token punctuation">{</span><span class="token punctuation">{</span>.Run.Registry<span class="token punctuation">}</span><span class="token punctuation">}</span>/node<span class="token punctuation">:</span>15<span class="token punctuation">-</span>alpine<span class="token punctuation">-</span><span class="token punctuation">{</span><span class="token punctuation">{</span>.Run.ID<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> push<span class="token punctuation">-</span>base<span class="token punctuation">-</span>image
    <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'retag-base-image'</span><span class="token punctuation">,</span> <span class="token string">'retag-base-image-unique-tag'</span><span class="token punctuation">]</span>
    <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;{{.Run.Registry}}/node:15-alpine&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;{{.Run.Registry}}/node:15-alpine-{{.Run.ID}}&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>Create an ACR Task to import and test the node base image</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>  az acr task create \
  --name base-import-node \
  -f acr-task.yaml \
  -r $REGISTRY_BASE_ARTIFACTS \
  --context $GIT_NODE_IMPORT \
  --git-access-token $(az keyvault secret show \
                        --vault-name $AKV \
                        --name github-token \
                        --query value -o tsv) \
  --set REGISTRY_FROM_URL=${REGISTRY_PUBLIC_URL}/ \
  --assign-identity
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Add credentials for our public registry</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task credential add \
  -n base-import-node \
    -r $REGISTRY_BASE_ARTIFACTS \
  --login-server $REGISTRY_PUBLIC_URL \
  -u https://${AKV}.vault.azure.net/secrets/registry-${REGISTRY_PUBLIC}-user \
  -p https://${AKV}.vault.azure.net/secrets/registry-${REGISTRY_PUBLIC}-password \
  --use-identity [system]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Grant access to read values from the KeyVault</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az keyvault set-policy \
  --name $AKV \
  --resource-group $AKV_RG \
  --object-id $(az acr task show \
                  --name base-import-node \
                  --registry $REGISTRY_BASE_ARTIFACTS \
                  --query identity.principalId --output tsv) \
  --secret-permissions get
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Run the import task:</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task run -n base-import-node -r $REGISTRY_BASE_ARTIFACTS
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>If the task fails due to <code>./test.sh: Permission denied</code> assure the script has execution permissions and commit back to the git repo:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">chmod</span> +x ./test.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="update-the-hello-world-image-to-build-from-the-gated-node-image"><a href="#update-the-hello-world-image-to-build-from-the-gated-node-image" class="header-anchor">#</a> Update the hello-world image to build from the gated node image</h2> <p>Add a <code>AcrPull</code> token to access the base-artifacts registry</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az keyvault secret set \
  --vault-name $AKV \
  --name &quot;registry-${REGISTRY_BASE_ARTIFACTS}-user&quot; \
  --value &quot;registry-${REGISTRY_BASE_ARTIFACTS}-user&quot;

az keyvault secret set \
  --vault-name $AKV \
  --name &quot;registry-${REGISTRY_BASE_ARTIFACTS}-password&quot; \
  --value $(az acr token create \
              --name &quot;registry-${REGISTRY_BASE_ARTIFACTS}-user&quot; \
              --registry $REGISTRY_BASE_ARTIFACTS \
              --repository node content/read \
              -o tsv \
              --query credentials.passwords[0].value)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>Add credentials for our Public Registry</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task credential add \
  -n hello-world \
    -r $REGISTRY \
  --login-server $REGISTRY_BASE_ARTIFACTS_URL \
  -u https://${AKV}.vault.azure.net/secrets/registry-${REGISTRY_BASE_ARTIFACTS}-user \
  -p https://${AKV}.vault.azure.net/secrets/registry-${REGISTRY_BASE_ARTIFACTS}-password \
  --use-identity [system]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Change the REGISTRY_FROM_URL to use the BASE_ARTIFACTS registry</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task update \
  -n hello-world \
  -r $REGISTRY \
  --set KEYVAULT=$AKV \
  --set REGISTRY_FROM_URL=${REGISTRY_BASE_ARTIFACTS_URL}/ \
  --set ACI=$ACI \
  --set ACI_RG=$ACI_RG
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Run the hello-world task to change it's base image dependency</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task run -r $REGISTRY -n hello-world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="update-the-base-image-with-a-valid-change"><a href="#update-the-base-image-with-a-valid-change" class="header-anchor">#</a> Update the base image with a &quot;valid&quot; change</h2> <p>Open the <code>Dockerfile</code> in base-image-node repo
Change the <code>BACKGROUND_COLOR</code> to <code>Green</code> to simulate a valid change.</p> <div class="language-Dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">ARG</span> REGISTRY_NAME=</span>
<span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${REGISTRY_NAME}</span>node:15-alpine</span>
<span class="token instruction"><span class="token keyword">ENV</span> NODE_VERSION 15-alpine</span>
<span class="token instruction"><span class="token keyword">ENV</span> BACKGROUND_COLOR Green</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Commit the change and monitor the sequence of updates</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>watch -n1 az acr task list-runs -r $REGISTRY_PUBLIC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once running, <code>ctrl+C</code> and monitor the logs</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task logs -r $REGISTRY_PUBLIC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once complete, monitor the base-image-import task</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>watch -n1 az acr task list-runs -r $REGISTRY_BASE_ARTIFACTS
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once running, <code>ctrl+C</code> and monitor the logs</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task logs -r $REGISTRY_BASE_ARTIFACTS
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once complete, monitor the hello-world task</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>watch -n1 az acr task list-runs -r $REGISTRY
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once running, <code>ctrl+C</code> and monitor the logs</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task logs -r $REGISTRY
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once complete, view the ACI hello-world image.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>explorer.exe <span class="token string">&quot;http://&quot;</span><span class="token variable"><span class="token variable">$(</span>az container show <span class="token punctuation">\</span>
  --resource-group $ACI_RG <span class="token punctuation">\</span>
  --name $<span class="token punctuation">{</span>ACI<span class="token punctuation">}</span> <span class="token punctuation">\</span>
  --query ipAddress.ip <span class="token punctuation">\</span>
  --out tsv<span class="token variable">)</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="view-the-gated-workflow"><a href="#view-the-gated-workflow" class="header-anchor">#</a> View the gated workflow</h3> <p>Perform the above steps again, with a background color of red</p> <p>Open the <code>Dockerfile</code> in base-image-node repo
Change the <code>BACKGROUND_COLOR</code> to <code>Red</code> to simulate a valid change.</p> <div class="language-Dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">ARG</span> REGISTRY_NAME=</span>
<span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${REGISTRY_NAME}</span>node:15-alpine</span>
<span class="token instruction"><span class="token keyword">ENV</span> NODE_VERSION 15-alpine</span>
<span class="token instruction"><span class="token keyword">ENV</span> BACKGROUND_COLOR Red</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Commit the change and monitor the sequence of updates</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>watch -n1 az acr task list-runs -r $REGISTRY_PUBLIC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once running, <code>ctrl+C</code> and monitor the logs</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task logs -r $REGISTRY_PUBLIC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once complete, monitor the base-image-import task</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>watch -n1 az acr task list-runs -r $REGISTRY_BASE_ARTIFACTS
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once running, <code>ctrl+C</code> and monitor the logs</p> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az acr task logs -r $REGISTRY_BASE_ARTIFACTS
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>At this point, you should see base-import-node fail validation and stop the sequence to publish a hello-world update.</p> <h3 id="publish-an-update-to-hello-world"><a href="#publish-an-update-to-hello-world" class="header-anchor">#</a> Publish an update to hello-world</h3> <p>Changes to the hello-world image will continue using the last validated node image.</p> <p>Any additional changes to the base-node image that pass the gated validations will trigger base-updates to the hello-world image.</p> <h2 id="cleaning-up"><a href="#cleaning-up" class="header-anchor">#</a> Cleaning up</h2> <div class="language-azurecli line-numbers-mode"><pre class="language-text"><code>az group delete -n $REGISTRY_RG --no-wait -y
az group delete -n $REGISTRY_PUBLIC_RG --no-wait -y
az group delete -n $REGISTRY_BASE_ARTIFACTS_RG --no-wait -y
az group delete -n $AKV_RG --no-wait -y
az group delete -n $ACI_RG --no-wait -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="next-steps"><a href="#next-steps" class="header-anchor">#</a> Next steps</h2> <ul><li><a href="/acr/container-registry-image-tag-version.html">Adopt tagging scheme for base image updates</a></li> <li><a href="/acr/container-registry-image-tag-version.html">Build images from stable service tags - can continue to receive security patches and framework updates.</a></li> <li><a href="/acr/container-registry-image-lock.html">Protect images using Image/tag locking</a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azure/acr/edit/master/docs/container-registry-consuming-public-content.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/acr/assets/js/app.3ca3959d.js" defer></script><script src="/acr/assets/js/2.4abe739f.js" defer></script><script src="/acr/assets/js/8.9e525704.js" defer></script>
  </body>
</html>
