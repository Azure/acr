---
title: Quickstart - Send connected registry  events to Azure Event Grid
description: Send connected registry events to Azure Event Grid.
ms.topic: quickstart
ms.date: 03/21/2022
ms.author: savaradh
author: savaradh
ms.custom:
---

# Quickstart: Send connected registry artifact events to Event Grid

In this quickstart, you will learn how to configure Connected registry [Azure Container Registry][container-registry-intro] to send artifact push and delete events to [Azure Event Grid][event-grid-overview] for processing and notification. You can review the [ACR connected registry introduction](intro-connected-registry.md) for details about the connected registry feature of Azure Container Registry.

## Scenario overview

As described in the [introduction][container-registry-intro], the connected registry synchronizes artifacts from the parent and also allows local push and delete of the artifacts. We can configure the connected registry to notify via [Azure Event Grid][event-grid-overview] whenever there is an update to the artifact. This will allow us to perform other actions based on the availability of the artifact on the connected registry.

## Prerequisites

- Use [Azure Cloud Shell](https://docs.microsoft.com/en-us/azure/cloud-shell/quickstart) using the bash environment.
  
  [![https://docs.microsoft.com/en-us/azure/includes/media/cloud-shell-try-it/hdi-launch-cloud-shell.png](https://docs.microsoft.com/en-us/azure/includes/media/cloud-shell-try-it/hdi-launch-cloud-shell.png)](https://shell.azure.com/)
- If you prefer, [install](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli) the Azure CLI to run CLI reference commands.
  - If you're using a local install, sign in with Azure CLI by using the [az login](https://docs.microsoft.com/en-us/cli/azure/reference-index#az_login) command. To finish the authentication process, follow the steps displayed in your terminal. See [Sign in with Azure CLI](https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli) for additional sign-in options.
  - When you're prompted, install Azure CLI extensions on first use. For more information about extensions, see [Use extensions with Azure CLI](https://docs.microsoft.com/en-us/cli/azure/azure-cli-extensions-overview).
  - Run [az version](https://docs.microsoft.com/en-us/cli/azure/reference-index?#az_version) to find the version and dependent libraries that are installed. To upgrade to the latest version, run [az upgrade](https://docs.microsoft.com/en-us/cli/azure/reference-index?#az_upgrade).
- The Azure CLI commands in this article are formatted for the Bash shell. If you're using a different shell like PowerShell or Command Prompt, you may need to adjust line continuation characters or variable assignment lines accordingly. This article uses variables to minimize the amount of command editing required.

## Before you begin

Make sure that you have created the connected registry resource in Azure as described in the [Create connected registry using the CLI](quickstart-connected-registry-cli.md) quickstart guide and have a connected registry deployed on your premises as described in [Quickstart: Deploy a connected registry to an IoT Edge device](quickstart-deploy-connected-registry-iot-edge-cli.md) or [Quickstart: Deploy a connected registry to Kubernetes cluster](quickstart-deploy-connected-registry-kubernetes.md). The connected registry image that is deployed should be of version atleast 0.6.0 

Also, make sure you understand [Azure Event Grid](https://docs.microsoft.com/en-us/azure/event-grid/) and have registered to use it. You should also have an event end point ready where you would like to send your events. You can check the quickstart to configure Azure Event Grid for Azure Container Registry events as shown in [QuickStart: Container registry events on Event Grid][quickstart-eventgrid-container-registry].

Before proceeding, set the event end point and other Azure Container Registry information.

```
APP_ENDPOINT=<your-app-endpoint>
ACR_NAME=mycontainerregistry001
ACR_CONNECTED_REGISTRY_NAME=myconnectedregistry
ACR_REGISTRY_ID=$(az acr show --name $ACR_NAME --query id --output tsv)
```

In this tutorial, we configure the connected registry to send artifact events like push and delete to Azure Event Grid in a two step process.

1. Configure connected registry to generate events on patterns of interest.
2. Configure Azure Event Grid to subscribe and filter for events generated by connected registry.

## Notification Events Generation on a connected registry

Use the following CLI command to configure the connected registry to generate notifications for push and delete events on all artifacts

```azurecli
az acr update -n $ACR_NAME
  --name $ACR_CONNECTED_REGISTRY_NAME \
  --add-notifications *:*
```

If you are interested in generating events only for specific artifact patterns or specific actions, you can specify the patterns in the form shown below

```azurecli
az acr update -n $ACR_NAME \
  --name $ACR_CONNECTED_REGISTRY_NAME \
  --add-notifications hello-world:* hello-world:1.0:delete \
  hello-world@sha256:92c7f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e899a:push 
```

The pattern is of the format

  ```
artifact ":" action
  ```

where `artifact` and `action` are further defined as

  ```yaml
artifact: name [ ":" tag ] [ "@" digest ]
action: "push" or "delete"
  ```

The wildcard `*` should be used to cover all values on a section. 

For example,

1. \*:\* - Notify all actions on all tags and digests on all artifacts on the connected registry
2. \*:\*:\*- Notify all actions on all tags on all artifacts on the connected registry
3. \*@\*:\*- Notify all actions on all digests on all artifacts on the connected registry
4. path/to/repo:\* - Notify all actions on all artifacts on repository '/path/to/repo' on the connected registry
5. path/to/repo:myTag:\* - Notify all actions on tag 'myTag' on repository '/path/to/repo' on the connected registry
6. path/to/repo@myDigest:delete - Notify only 'delete' action on digest 'myDigest' on repository '/path/to/repo' on the connected registry
7. path/to/repo/\*:push - Notify only 'push' action on all artifacts on all repositories that match '/path/to/repo/\*' on the connected registry

## Event Grid Subscription and filtering Connected Registry Events on Event Grid

In this step, you will configure eventgrid to subscribe for events from connected registry. You can use the `--advanced-filter` on event grid to filter out connected registry specific events. The connected registry events will align to the existing Azure Container Registry event types `Microsoft.ContainerRegistry.ImagePushed` and `Microsoft.ContainerRegistry.ImageDeleted`. 

1. To filter events from all connected registries

  ```azurecli
az eventgrid event-subscription create \
    --name event-sub-acr \
    --source-resource-id $ACR_REGISTRY_ID \
    --endpoint $APP_ENDPOINT \
    --advanced-filter data.connectedregistry IsNotNull 
  ```

2. To filter connected registry events based on connected registry name

  ```azurecli
az eventgrid event-subscription create \
    --name event-sub-acr \
    --source-resource-id $ACR_REGISTRY_ID \
    --endpoint $APP_ENDPOINT \
    --advanced-filter data.connectedregistry IsNotNull \
    --advanced-filter data.connectedregistry.name StringIn $ACR_CONNECTED_REGISTRY_NAME
  ```

Whenever there is a push or delete on any artifact on the connected registry, you will see the events as shown below. The events might take multiples of sync interval time to appear on endpoint based on the depth of the connected registry heirarchy. 

- `Microsoft.ContainerRegistry.ImagePushed` event

```yaml
[{
  "id": "831e1650-001e-001b-66ab-eeb76e069631",
  "topic": "/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.ContainerRegistry/registries/<registry-name>/connectedRegistries/<connected-registry-name>",
  "subject": "aci-helloworld:v1",
  "eventType": "Microsoft.ContainerRegistry.ImagePushed",
  "eventTime": "2018-04-25T21:39:47.6549614Z",
  "data": {
    "id": "31c51664-e5bd-416a-a5df-e5206bc47ed0",
    "timestamp": "2018-04-25T21:39:47.276585742Z",
    "action": "push",
    "target": {
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "size": 3023,
      "digest": "sha256:213bbc182920ab41e18edc2001e06abcca6735d87782d9cef68abd83941cf0e5",
      "repository": "aci-helloworld",
      "tag": "v1",
      "length": 3023,
    },
    "connectedregistry": {
      "name": "<connected-registry-name>"
    },
  },
  "dataVersion": "2.0",
  "metadataVersion": "1"
}]
```

- `Microsoft.ContainerRegistry.ImageDeleted` event

  ```yaml
  [{
   "id": "831e1650-001e-001b-66ab-eeb76e069631",
   "topic": "/subscriptions/<subscription-id>/resourceGroups/<resource-group- name>/providers/Microsoft.ContainerRegistry/registries/<registry-name>/connectedRegistries/<connected-registry-name>",
   "subject": "aci-helloworld",
   "eventType": "Microsoft.ContainerRegistry.ImageDeleted",
   "eventTime": "2018-04-25T21:39:47.6549614Z",
   "data": {
     "id": "31c51664-e5bd-416a-a5df-e5206bc47ed0",
     "timestamp": "2018-04-25T21:39:47.276585742Z",
     "action": "delete",
     "target": {
       "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
       "digest": "sha256:213bbc182920ab41e18edc2001e06abcca6735d87782d9cef68abd83941cf0e5",
       "repository": "aci-helloworld",
     },
     "connectedregistry": {
       "name": "<connected-registry-name>"
     },  
   },
   "dataVersion": "2.0",
   "metadataVersion": "1"
  }]
  ```

Please note that, if you already have event subscriptions on event grid for the concerned Azure Container Registry and you later configure generation of events on connected registry using CLI, you will immediately start to see the new connected registry events on those existing event grid subscriptions.

<!-- LINKS - internal -->
[container-registry-intro]: https://docs.microsoft.com/azure/container-registry/
[event-grid-overview]: (https://docs.microsoft.com/en-us/azure/event-grid/overview)
[quickstart-eventgrid-container-registry]: https://docs.microsoft.com/en-us/azure/container-registry/container-registry-event-grid-quickstart?toc=/azure/event-grid/toc.json