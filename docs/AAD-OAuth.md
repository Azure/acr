# Azure Container Registry integration with Azure Active Directory

The Azure Container Registry allows users to manage a private Docker registry on the cloud. Our service enables customers to store and manage container images across all types of Azure deployments, keep container images near deployments to reduce latency and costs, maintain Windows and Linux container images in a single Docker registry, use familiar, open-source Docker command line interface (CLI) tools, and simplify registry access management with Azure Active Directory.

The integration of Azure Container Registry with Azure Active Directory is crucial in order to enable transparent authentication and authorization of users and headless services using AAD credentials. In this scenario, a user will only have to use their AAD credentials to log-in to their private registry, and the Azure Container Service will take care of the authorization validation of each operation using the provided credentials.

Under the hood Azure Container Service utilizes the [oauth2](https://oauth.net/2/) authorization protocol, as described by the [Docker Registry v2 authentication via central service documentation](https://docs.docker.com/registry/spec/auth/token/) as well as the [Docker Registry v2 Bearer token specification](https://docs.docker.com/registry/spec/auth/jwt/). The JWT tokens generated by the Azure Container Registry are easy to observe in [jwt.io](https://jwt.io/).

## Authenticating to a registry with Azure CLI

The process to log in to the registry, from the user's perspective, is simple. The user will use the Microsoft Azure CLI 2.0:

```bash
az acr login -n contosoregistry
```

Internally, the CLI will follow these steps:
  1. Calls to Azure Resource Manager to resolve the login server for the specified registry.
  2. Obtains refresh credentials from the profile in use. For a headless call, this will give you the registered SPN, for a regular user this will give you a refresh token.
  3. Makes an HTTPS GET call to the registry server's `/v2` endpoint, without credentials. A bearer token authentication challenge is expected, specifying realm and service values. The realm contains the authentication server's URL.
  4. Makes an HTTPS POST call to the authentication server's `POST /oauth2/exchange` endpoint, with a body indicating the grant type, the service, the tenant, and the credentials.
  5. From the server's response, we extract an Azure Container Registry refresh token.
  6. Pass the refresh token as the password to the Docker CLI, using a null GUID as the username and calling `docker login`. From here on, the docker CLI takes care of the authorization cycle using oauth2.

At the end Docker will store the refresh token and go through the oauth2 flow on each operation it does against the Azure Container Registry.

## Listing a repository with Azure CLI

The Microsoft Azure CLI 2.0 allows users to also list the repositories registries, and list tags for a repository in a registry. Here's how users can achieve listing the repositories in a registry:
```
az acr repository list -n contosoregistry
```

Internally, the CLI will follow these steps:
  1. Calls to Azure Resource Manager to resolve the login server for the specified registry.
  2. Obtains refresh credentials from the profile in use. For a headless call, this will give you the registered SPN, for a regular user this will give you a refresh token.
  3. Makes an HTTPS GET call to the registry server's `/v2` endpoint, without credentials. A bearer token authentication challenge is expected, specifying realm and service values. The realm contains the authentication server's URL.
  4. Makes an HTTPS POST call to the authentication server's `POST /oauth2/exchange` endpoint, with a body indicating the grant type, the service, the tenant, and the credentials.
  5. From the server's response we extract an Azure Container Registry refresh token.
  6. Makes an HTTPS POST call to the authentication server's `POST /oauth2/token` endpoint, with a body indicating the grant type, the service, the scope, and the Azure Container Registry refresh token.
  7. From the server's response we extract an Azure Container Registry access token.
  8. Makes an HTTPS GET call to the registry server's `GET /v2/_catalog` endpoint using the access token as the bearer token.
  9. Obtains the data from the service and displays it.

When listing the tags of a repository, every step above is the same except for the call to the endpoint that gives the tags which is `GET /v2/contosoregistry/tags/list` instead of `GET /v2/_catalog`.

# Azure Container Registry refresh tokens and access tokens

Let's follow an example call to list a repository:

```bash
az acr repository list -n contosoregistry
```

This will produce a JWT refresh token with the following payload:

```json
{
  "jti": "365e3b5b-844e-4a21-a38c-4d8aebdd6a06",
  "sub": "user@contoso.com"
  "nbf": 1497988712,
  "exp": 1497990801,
  "iat": 1497988712,
  "iss": "Azure Container Registry",
  "aud": "contosoregistry.azurecr.io",
  "version": "1.0",
  "grant_type": "access_token_refresh_token",
  "tenant": "409520d4-8100-4d1d-ad47-72432ddcc120",
  "credential": "AQA...iAA"
  "permissions": {
    "actions": [
      "*"
    ],
    "notActions": []
  }
}
```

Followed by an access token with the following payload:

```json
{
  "jti": "ec425c1e-7eda-4f70-adb5-19f927e34a41",
  "sub": "user@contoso.com"
  "nbf": 1497988907,
  "exp": 1497993407,
  "iat": 1497988907,
  "iss": "Azure Container Registry",
  "aud": "contosoregistry.azurecr.io",
  "access": [
    {
      "type": "registry",
      "name": "catalog",
      "actions": [
        "*"
      ]
    }
  ]
}
```

# Getting credentials programatically

In order to sign in to a container you'll need to exchange AAD credentials for ACR credentials. The accepted form of credential exchange are:
  - AAD access token.
  - AAD refresh token.
  - AAD access token and refresh token.

Ideally you'll present both the AAD access token and the AAD refresh token. The AAD access token is used to talk to the Azure Resource Manager and query for the set of permissions that the user has for the container registry resource. The AAD refresh token is used in two ways:
  1. If no AAD access token was presented, the AAD refresh token is used to obtain an AAD access token.
  2. The AAD refresh token is sent back to the user so they can initiate a token refresh cycle against AAD. If no AAD refresh token is sent, then the client won't have this credential at hand to initiate a credential refresh.

The cycle to get credentials looks as follows:
  1. Call `POST /oauth2/exchange` presenting the AAD refresh token and the AAD access token. The service will return you an ACR refresh token.
  2. Call `POST /oauth2/token` presenting the ACR refresh token. The service will return you an ACR access token which you can use to call the Azure Container Registry's APIs.

## Calling `POST /oauth2/exchange` to get an ACR refresh token

In this example, we'll try to obtain an ACR refresh token from existing AAD tokens. Assume you have the following:
  1. A valid container registry, which here we'll call `contosoregistry.azurecr.io`.
  2. The AAD tenant identifier associated to the credentials, which here we'll take to be `409520d4-8100-4d1d-ad47-72432ddcc120`.
  3. Valid AAD access token and AAD refresh token credentials with access to the aforementioned container registry.

The AAD access token and AAD refresh token can be obtained from the Azure CLI. After running `az login` check file `$HOME/.azure/accessTokens.json` (`%HOMEDRIVE%%HOMEPATH%\.azure\accessTokens.json` in Windows) for the token values.

We'll now call `POST /oauth2/exchange` to exchange the AAD tokens for an ACR refresh token. Here's how such a call looks when done via `curl`:
```bash
export registry="contosoregistry.azurecr.io"
export tenant="409520d4-8100-4d1d-ad47-72432ddcc120"
export aad_refresh_token="AQA...iAA"
export aad_access_token="eyJ...H-g"
curl -v -X POST -H "Content-Type: application/x-www-form-urlencoded" -d \
"grant_type=access_token_refresh_token&service=$registry&tenant=$tenant&refresh_token=$aad_refresh_token&access_token=$aad_access_token" \
https://$registry/oauth2/exchange
```

The body of the POST message is a querystring-like text that specifies the following values:
  - `grant_type`, which can take a value of `access_token_refresh_token`, or `access_token`, or `refresh_token`.
  - `service`, which must indicate the name of your Azure container registry.
  - `tenant`, which is the AAD tenant associated to the AAD credentials.
  - `refresh_token`, the AAD refresh token, mandatory when `grant_type` is `access_token_refresh_token` or `refresh_token`.
  - `access_token`, the AAD access token, mandatory when `grant_type` is `access_token_refresh_token` or `access_token`.

The outcome of this operation will be a response with status 200 OK and a body with the following JSON payload:

```json
{"refresh_token":"eyJ...L7a"}
```

This response is the ACR refresh token which you can inspect with [jwt.io](https://jwt.io/). You can now use it to obtain an ACR access token programmatically or simply send it to the `docker login` command to get docker talking to the Azure Container Registry.

## Authenticating docker with an ACR refresh token

Once you have obtained an ACR refresh token, you can use the docker CLI to sign in to your registry like this:

```bash
export registry="contosoregistry.azurecr.io"
export acr_username="00000000-0000-0000-0000-000000000000"
export acr_refresh_token="eyJ...L7a"
docker login -u "$acr_username" -p "$acr_refresh_token" $registry
```

The null GUID tells the container registry that this is an ACR refresh token during the login flow. Once the authentication succeeds you can talk to the Azure Container Registry with commands like `docker pull` and `docker push`. For example:

```bash
docker pull contosoregistry.azurecr.io/contoso-marketing
```

Notice that the ACR refresh token will be saved by the docker CLI in its credential store, and will be used by the docker CLI to obtain an ACR access token on each operation it performs against the Azure Container Registry. The ACR refresh token is made so it stops working after a period of time, but if you obtained it using either `grant_type=access_token_refresh_token` or `grant_type=refresh_token` then it can be refreshed automatically by installing the [ACR docker credential helper](https://github.com/azure/acr-docker-credential-helper).

## Calling `POST /oauth2/token` to get an ACR access token

In this example, we'll try to obtain an ACR access token from existing ACR refresh token, and this access token will only work for the operation we're trying to perform, which is a call to the `GET /v2/_catalog` API. Assume you have the following:
  1. A valid container registry, which here we'll call `contosoregistry.azurecr.io`.
  2. A valid ACR refresh token.

The first thing you want is to obtain an authentication challenge for the operation you want to on the Azure Container Registry. That can be done by targetting the API you want to call without any authentication. Here's how to do that via `curl`:

```bash
export registry="contosoregistry.azurecr.io"
curl -v https://$registry/v2/_catalog
```

Note that `curl` by default does the request as a `GET` unless you specify a different verb with the `-X` modifier.

This will output the following payload, with `...` used to shorten it for illustrative purposes:

```html
< HTTP/1.1 401 Unauthorized
...
< Www-Authenticate: Bearer realm="https://contosoregistry.azurecr.io/oauth2/token",service="contosoregistry.azurecr.io",scope="registry:catalog:*"
...
{"errors":[{"code":"UNAUTHORIZED","message":"authentication required","detail":[{"Type":"registry","Name":"catalog","Action":"*"}]}]}
```

Notice the response payload has a header called `Www-Authenticate` that gives us the following information:
  - The type of challenge: `Bearer`.
  - The realm of the challenge: `https://contosoregistry.azurecr.io/oauth2/token`.
  - The service of the challenge: `contosoregistry.azurecr.io`.
  - The scope of the challenge: `registry:catalog:*`.

The body of the payload might provide additional details, but all the information you need is contained in the `Www-Authenticate` header.

With this information we're now ready to call `POST /oauth2/token` to obtain an ACR access token that will allow us to use the `GET /v2/_catalog` API. Here's how such a call looks when done via `curl`:

```bash
export registry="contosoregistry.azurecr.io"
export acr_refresh_token="eyJ...L7a"
export scope="registry:catalog:*"
curl -v -X POST -H "Content-Type: application/x-www-form-urlencoded" -d \
"grant_type=refresh_token&service=$registry&scope=$scope&refresh_token=$acr_refresh_token" \
https://$registry/oauth2/token
```

The body of the POST message is a querystring-like text that specifies the following values:
  - `grant_type` which is expected to be `refresh_token`.
  - `service`, which must indicate the name of your Azure container registry. You obtained this from the `Www-Authenticate` response header from the challenge.
  - `scope`, which is expected to be a valid [scope](https://docs.docker.com/registry/spec/auth/scope/), and can be specified more than once for multiple scope requests. You obtained this from the `Www-Authenticate` response header from the challenge.
  - `refresh_token`, which must be a valid ACR refresh token, as obtained by calling `POST /oauth2/exchange`.

The outcome of this operation will be a response with status 200 OK and a body with the following JSON payload:
```json
{"access_token":"eyJ...xcg"}
```
This response is the ACR access token which you can inspect with [jwt.io](https://jwt.io/). You can now use it to call APIs exposed by the Azure Container Registry

## Calling `POST /oauth2/token` to get an ACR access token for Helm repository

In this example, we'll try to obtain an ACR access token from existing ACR refresh token to access Helm repository, and this access token will only work for the operation we're trying to perform, which is a call to the `GET /helm/v1/repo/index.yaml` API. Assume you have the following:
  1. A valid container registry, which here we'll call `contosoregistry.azurecr.io`.
  2. A valid ACR refresh token.

The first thing you want is to obtain an authentication challenge for the operation you want to on the Azure Container Registry. That can be done by targetting the API you want to call without any authentication. Here's how to do that via `curl`:

```bash
export registry="contosoregistry.azurecr.io"
curl -v https://$registry/helm/v1/repo/index.yaml
```

Note that `curl` by default does the request as a `GET` unless you specify a different verb with the `-X` modifier.

This will output the following payload, with `...` used to shorten it for illustrative purposes:

```bash
< HTTP/1.1 401 Unauthorized
...
< Www-Authenticate: Bearer realm="https://contosoregistry.azurecr.io/oauth2/token",service="contosoregistry.azurecr.io",scope="artifact-repository:repo:pull"
...
{"errors":[{"code":"UNAUTHORIZED","message":"authentication required","detail":[{"Type":"artifact-repository","Name":"repo","Action":"pull"}]}]}
```

Notice the response payload has a header called `Www-Authenticate` that gives us the following information:
  - The type of challenge: `Bearer`.
  - The realm of the challenge: `https://contosoregistry.azurecr.io/oauth2/token`.
  - The service of the challenge: `contosoregistry.azurecr.io`.
  - The scope of the challenge: `artifact-repository:repo:pull`.

The body of the payload might provide additional details, but all the information you need is contained in the `Www-Authenticate` header.

With this information we're now ready to call `POST /oauth2/token` to obtain an ACR access token that will allow us to use the `GET /helm/v1/repo/index.yaml` API. Here's how such a call looks when done via `curl`:

```bash
export registry="contosoregistry.azurecr.io"
export acr_refresh_token="eyJ...L7a"
export scope="artifact-repository:repo:pull"
curl -v -X POST -H "Content-Type: application/x-www-form-urlencoded" -d \
"grant_type=refresh_token&service=$registry&scope=$scope&refresh_token=$acr_refresh_token" \
https://$registry/oauth2/token
```

The body of the POST message is a querystring-like text that specifies the following values:
  - `grant_type` which is expected to be `refresh_token`.
  - `service`, which must indicate the name of your Azure container registry. You obtained this from the `Www-Authenticate` response header from the challenge.
  - `scope`, which is expected to be a `artifact-repository:repo:pull` for read operations and `artifact-repository:repo:*` for write operations, and can be specified more than once for multiple scope requests. You obtained this from the `Www-Authenticate` response header from the challenge.
  - `refresh_token`, which must be a valid ACR refresh token, as obtained by calling `POST /oauth2/exchange`.

The outcome of this operation will be a response with status 200 OK and a body with the following JSON payload:
```json
{"access_token":"eyJ...xcg"}
```

This response is the ACR access token which you can inspect with [jwt.io](https://jwt.io/). You can now use it to call APIs exposed by the Azure Container Registry. Refer the full script to [fetch the helm index.yaml](#fetch-helm-index.yaml).

## Calling an Azure Container Registry API

In this example we'll call the `GET /v2/_catalog` API on an Azure Container Registry. Assume you have the following:
  1. A valid container registry, which here we'll call `contosoregistry.azurecr.io`.
  2. A valid ACR access token, created with the correct scope for the API we're going to call.

Here's how a call to the `GET /v2/_catalog` API of the given registry would look like when done via `curl`:

```bash
export registry="contosoregistry.azurecr.io"
export acr_access_token="eyJ...xcg"
curl -v -H "Authorization: Bearer $acr_access_token" https://$registry/v2/_catalog
```
Note that `curl` by default does the request as a `GET` unless you specify a different verb with the `-X` modifier.

This should result in a status 200 OK, and a body with a JSON payload listing the repositories held in this registry:

```json
{"repositories":["alpine","hello-world","contoso-marketing"]}
```

### Full script to call Azure Container Registry API

This is a summary script of the points discussed above. The first three variables have to be filled out.

- Variable `registry` can be something like `"contosoregistry.azurecr.io"`.
- The AAD access token and AAD refresh token values can be obtained from the Azure CLI, after running az login check file `$HOME/.azure/accessTokens.json` (`%HOMEDRIVE%%HOMEPATH%\.azure\accessTokens.json` in Windows) for the token values.

Note that stale AAD tokens will result in this script failing to obtain an ACR refresh token, and therefore it won't succeed in obtaining an ACR access token or in executing the operation against the registry.

```bash
#!/bin/bash

export registry=" --- you have to fill this out --- "
export aad_refresh_token=" --- you have to fill this out --- "
export aad_access_token=" --- you have to fill this out --- "

export operation="/v2/_catalog"

export acr_refresh_token=$(curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "grant_type=access_token_refresh_token&service=$registry&refresh_token=$aad_refresh_token&access_token=$aad_access_token" https://$registry/oauth2/exchange | jq '.refresh_token' | sed -e 's/^"//' -e 's/"$//')
echo "ACR Refresh Token"
echo $acr_refresh_token

export challenge=$(curl -vs https://$registry$operation 2>&1 | grep "Www-Authenticate:")
echo "Challenge"
echo $challenge

export scope=$(echo $challenge | egrep -o 'scope=\"([^\"]*)\"' | egrep -o '\"([^\"]*)\"' | sed -e 's/^"//' -e 's/"$//')
echo "Scope"
echo $scope

export acr_access_token=$(curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "grant_type=refresh_token&service=$registry&scope=$scope&refresh_token=$acr_refresh_token" https://$registry/oauth2/token | jq '.access_token' | sed -e 's/^"//' -e 's/"$//')
echo "ACR Access Token"
echo $acr_access_token

export catalog=$(curl -s -H "Authorization: Bearer $acr_access_token" https://$registry$operation)
echo "Catalog"
echo $catalog
```

Here's an equivalent set of scripts that will allow you to execute an operation against an Azure Container Registry, but this time using only the admin credentials, and not AAD.

If you'd like to use basic auth, you can do a direct call to the registry like this:

```bash
#!/bin/bash
 
export registry=" --- you have to fill this out --- "
export user=" --- you have to fill this out --- "
export password=" --- you have to fill this out --- "
 
export operation="/v2/_catalog"
 
export credentials=$(echo -n "$user:$password" | base64 -w 0)
 
export catalog=$(curl -s -H "Authorization: Basic $credentials" https://$registry$operation)
echo "Catalog"
echo $catalog
```

If you'd like to use bearer auth, you have to first convert your admin credentials to an ACR access token like this:

```bash
#!/bin/bash
 
export registry=" --- you have to fill this out --- "
export user=" --- you have to fill this out --- "
export password=" --- you have to fill this out --- "
 
export operation="/v2/_catalog"
 
export challenge=$(curl -vs https://$registry$operation 2>&1 | grep "Www-Authenticate:")
echo "Challenge"
echo $challenge
 
export scope=$(echo $challenge | egrep -o 'scope=\"([^\"]*)\"' | egrep -o '\"([^\"]*)\"' | sed -e 's/^"//' -e 's/"$//')
echo "Scope"
echo $scope

export credentials=$(echo -n "$user:$password" | base64 -w 0)
 
export acr_access_token=$(curl -s -H "Content-Type: application/x-www-form-urlencoded" -H "Authorization: Basic $credentials" "https://$registry/oauth2/token?service=$registry&scope=$scope" | jq '.access_token' | sed -e 's/^"//' -e 's/"$//')
echo "ACR Access Token"
echo $acr_access_token
 
export catalog=$(curl -s -H "Authorization: Bearer $acr_access_token" https://$registry$operation)
echo "Catalog"
echo $catalog
```
### Fetch helm index.yaml 

```bash
#!/bin/bash

export registry=" --- you have to fill this out --- "
export user=" --- you have to fill this out --- "
export password=" --- you have to fill this out --- "

export operation="/helm/v1/repo/index.yaml"
 
export challenge=$(curl -vs https://$registry$operation 2>&1 | grep "Www-Authenticate:")
echo "Challenge"
echo $challenge
 
export scope=$(echo $challenge | egrep -o 'scope=\"([^\"]*)\"' | egrep -o '\"([^\"]*)\"' | sed -e 's/^"//' -e 's/"$//')
echo "Scope"
echo $scope
 
export credentials=$(echo -n "$user:$password" | base64 )
 
export acr_access_token=$(curl -s -H "Content-Type: application/x-www-form-urlencoded" \
 -H "Authorization: Basic $credentials" "https://$registry/oauth2/token?service=$registry&scope=$scope" | jq '.access_token' | sed -e 's/^"//' -e 's/"$//')
echo "ACR Access Token"
echo $acr_access_token
 
#Retrieve the location header and strip the trailing \r for curl
export URL=$(curl -sD - -H "Authorization: Bearer $acr_access_token" https://$registry$operation  | grep -Fi Location | awk '{print $2}' | tr -d '\r')
echo Location=$URL
echo index.yaml
echo ----------
curl $URL
```